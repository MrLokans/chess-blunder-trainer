{% extends "base.html" %}
{% from "_nav.html" import render_nav %}

{% block title %}Management - Blunder Tutor{% endblock %}

{% block content %}
<h1>Management</h1>
{{ render_nav('management') }}

<div class="card">
  <h2>Chess Engine Status</h2>
  <div id="engineStatus">
    <p style="color: var(--text-muted); font-size: 0.875rem;">Loading engine status...</p>
  </div>
</div>

<div class="card">
  <h2>Bulk Import Games</h2>
  <div id="importMessage" style="display: none;"></div>
  <form id="importForm">
    <div class="form-group">
      <label for="source">Source</label>
      <select id="source" required>
        <option value="">Select source...</option>
        <option value="lichess">Lichess</option>
        <option value="chesscom">Chess.com</option>
      </select>
    </div>
    <div class="form-group">
      <label for="username">Username</label>
      <input type="text" id="username" required placeholder="Enter username">
    </div>
    <div class="form-group">
      <label for="maxGames">Maximum Games</label>
      <input type="number" id="maxGames" value="1000" min="1" max="10000">
    </div>
    <button type="submit" class="btn">Start Import</button>
  </form>

  <div id="importProgress" style="display: none; margin-top: 24px;">
    <p><strong>Import in progress...</strong></p>
    <div class="progress-bar">
      <div class="progress-fill" id="importProgressFill" style="width: 0%"></div>
      <div class="progress-text" id="importProgressText">0%</div>
    </div>
  </div>
</div>

<div class="card">
  <h2>Sync Games</h2>
  <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 16px;">
    Fetch new games from all configured sources.
  </p>
  <button class="btn" onclick="startSync()">Sync Now</button>
  <div id="syncStatus" style="margin-top: 16px;"></div>
</div>

<div class="card">
  <h2>Analyze Games</h2>
  <div id="analysisMessage" style="display: none;"></div>

  <div id="analysisInfo" style="margin-bottom: 16px;">
    <p style="color: var(--text-muted); font-size: 0.875rem;">
      <span id="unanalyzedCount">-</span> games pending analysis
    </p>
  </div>

  <div id="analysisControls">
    <button class="btn" id="startAnalysisBtn" onclick="startAnalysis()">Analyze All Games</button>
    <button class="btn" id="stopAnalysisBtn" onclick="stopAnalysis()" style="display: none; background: var(--error);">Stop Analysis</button>
  </div>

  <div id="analysisProgress" style="display: none; margin-top: 24px;">
    <p><strong>Analysis in progress...</strong></p>
    <div class="progress-bar">
      <div class="progress-fill" id="analysisProgressFill" style="width: 0%"></div>
      <div class="progress-text" id="analysisProgressText">0%</div>
    </div>
  </div>
</div>

<div class="card">
  <h2>Backfill Game Phases</h2>
  <div id="backfillMessage" style="display: none;"></div>

  <div id="backfillInfo" style="margin-bottom: 16px;">
    <p style="color: var(--text-muted); font-size: 0.875rem;">
      Backfill phase data (opening/middlegame/endgame) for analyzed games.
      <br>
      <span id="backfillPendingCount">-</span> games pending phase backfill
    </p>
  </div>

  <div id="backfillControls">
    <button class="btn" id="startBackfillBtn" onclick="startBackfillPhases()">Backfill Phases</button>
  </div>

  <div id="backfillProgress" style="display: none; margin-top: 24px;">
    <p><strong>Backfill in progress...</strong></p>
    <div class="progress-bar">
      <div class="progress-fill" id="backfillProgressFill" style="width: 0%"></div>
      <div class="progress-text" id="backfillProgressText">0%</div>
    </div>
  </div>
</div>

<div class="card">
  <h2>Backfill ECO Codes</h2>
  <div id="ecoBackfillMessage" style="display: none;"></div>

  <div id="ecoBackfillInfo" style="margin-bottom: 16px;">
    <p style="color: var(--text-muted); font-size: 0.875rem;">
      Backfill ECO opening codes for analyzed games.
      <br>
      <span id="ecoBackfillPendingCount">-</span> games pending ECO classification
    </p>
  </div>

  <div id="ecoBackfillControls">
    <button class="btn" id="startEcoBackfillBtn" onclick="startBackfillECO()">Backfill ECO Codes</button>
  </div>

  <div id="ecoBackfillProgress" style="display: none; margin-top: 24px;">
    <p><strong>ECO backfill in progress...</strong></p>
    <div class="progress-bar">
      <div class="progress-fill" id="ecoBackfillProgressFill" style="width: 0%"></div>
      <div class="progress-text" id="ecoBackfillProgressText">0%</div>
    </div>
  </div>
</div>

<div class="card">
  <h2>Recent Jobs</h2>
  <table id="jobsTable">
    <thead>
      <tr>
        <th>Type</th>
        <th>Status</th>
        <th>Username</th>
        <th>Source</th>
        <th>Progress</th>
        <th>Created</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="jobsTableBody"
           hx-get="/api/jobs/html"
           hx-trigger="load, jobsRefresh from:body"
           hx-swap="innerHTML">
      <tr>
        <td colspan="7" style="text-align: center; color: var(--text-muted);">Loading...</td>
      </tr>
    </tbody>
  </table>
</div>

<div class="card" style="border-color: var(--error);">
  <h2 style="color: var(--error);">Danger Zone</h2>
  <div id="deleteAllMessage" style="display: none;"></div>
  <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 16px;">
    Delete all imported games, analysis results, puzzle attempts, and job history.
    <strong>This action cannot be undone.</strong> Your settings will be preserved.
  </p>
  <button class="btn" id="deleteAllBtn" onclick="confirmDeleteAll()" style="background: var(--error);">
    Delete All Data
  </button>

  <div id="deleteAllProgress" style="display: none; margin-top: 24px;">
    <p><strong>Deleting data...</strong></p>
    <div class="progress-bar">
      <div class="progress-fill" id="deleteAllProgressFill" style="width: 0%; background: var(--error);"></div>
      <div class="progress-text" id="deleteAllProgressText">0%</div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/management.js"></script>
{% endblock %}
