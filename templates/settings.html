{% extends "base.html" %}

{% block title %}Settings - Blunder Tutor{% endblock %}

{% block extra_css %}
<style>
  body {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .container {
    max-width: 580px;
  }

  .theme-section-title {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--text-muted);
    margin: var(--space-5) 0 var(--space-3) 0;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }

  .theme-section-title:first-child {
    margin-top: 0;
  }

  .preset-selector {
    margin-bottom: var(--space-5);
    padding-bottom: var(--space-5);
    border-bottom: 1px solid var(--border);
  }

  .preset-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: var(--space-2);
  }

  .preset-card {
    padding: var(--space-2);
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.15s ease;
    background: var(--bg-elevated);
    text-align: center;
  }

  .preset-card:hover {
    border-color: var(--color-primary-muted);
    transform: translateY(-1px);
  }

  .preset-card.active {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px rgba(79, 109, 122, 0.2);
  }

  .preset-colors {
    display: flex;
    gap: 2px;
    margin-bottom: var(--space-1);
    justify-content: center;
  }

  .preset-color-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 1px solid rgba(0,0,0,0.1);
  }

  .preset-name {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--text);
    margin-bottom: 2px;
  }

  .preset-desc {
    font-size: 0.65rem;
    color: var(--text-muted);
    line-height: 1.2;
    display: none;
  }

  @media (max-width: 500px) {
    .preset-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  .color-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-3) var(--space-4);
  }

  .color-grid .form-group {
    margin-bottom: 0;
  }

  .color-grid .help-text {
    font-size: 0.7rem;
  }

  .color-input-row {
    display: flex;
    gap: var(--space-2);
    align-items: center;
  }

  .color-input-row input[type="color"] {
    width: 40px;
    height: 32px;
    padding: 2px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    background: var(--bg-elevated);
  }

  .color-input-row input[type="color"]::-webkit-color-swatch-wrapper {
    padding: 2px;
  }

  .color-input-row input[type="color"]::-webkit-color-swatch {
    border: none;
    border-radius: 3px;
  }

  .color-hex-input {
    width: 80px !important;
    font-family: var(--font-mono);
    font-size: var(--text-xs);
    text-transform: uppercase;
    padding: var(--space-2) !important;
  }

  .theme-preview {
    margin-top: var(--space-5);
    padding: var(--space-4);
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
  }

  .preview-label {
    font-size: var(--text-xs);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--text-muted);
    margin-bottom: var(--space-3);
  }

  .preview-buttons {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: var(--space-3);
  }

  .preview-phases {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .phase-pill {
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius);
    font-size: var(--text-xs);
    font-weight: 600;
    color: white;
  }

  .preview-heatmap {
    margin-top: var(--space-3);
  }

  .preview-heatmap-label {
    font-size: var(--text-xs);
    color: var(--text-muted);
    margin-bottom: var(--space-2);
  }

  .preview-heatmap-grid {
    display: flex;
    gap: 3px;
  }

  .preview-heatmap-week {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  .preview-heatmap-cell {
    width: 10px;
    height: 10px;
    border-radius: 2px;
  }

  .preview-heatmap-cell.level-0 { background: var(--heatmap-empty, #ebedf0); }
  .preview-heatmap-cell.level-1 { background: var(--heatmap-l1, #9be9a8); }
  .preview-heatmap-cell.level-2 { background: var(--heatmap-l2, #40c463); }
  .preview-heatmap-cell.level-3 { background: var(--heatmap-l3, #30a14e); }
  .preview-heatmap-cell.level-4 { background: var(--heatmap-l4, #216e39); }

  .phase-pill.opening {
    background: var(--color-phase-opening);
  }

  .phase-pill.middlegame {
    background: var(--color-phase-middlegame);
  }

  .phase-pill.endgame {
    background: var(--color-phase-endgame);
  }

  .preview-primary {
    background: var(--color-primary) !important;
    border-color: var(--color-primary) !important;
  }

  .preview-success {
    background: var(--color-success) !important;
    border-color: var(--color-success) !important;
  }

  .preview-error {
    background: var(--color-error) !important;
    border-color: var(--color-error) !important;
  }

  /* Board styling */
  .board-preview-container {
    display: flex;
    gap: var(--space-4);
    align-items: flex-start;
  }

  .board-preview {
    width: 160px;
    height: 160px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(4, 1fr);
    border-radius: var(--radius-md);
    overflow: hidden;
    box-shadow: var(--shadow-md);
    flex-shrink: 0;
  }

  .board-preview .square {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .board-preview .square img {
    width: 80%;
    height: 80%;
    object-fit: contain;
  }

  .board-preview .square.light {
    background: var(--preview-board-light, #f0d9b5);
  }

  .board-preview .square.dark {
    background: var(--preview-board-dark, #b58863);
  }

  .board-settings-controls {
    flex: 1;
  }

  .piece-set-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-2);
    margin-bottom: var(--space-4);
  }

  .piece-set-card {
    padding: var(--space-2) var(--space-3);
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.15s ease;
    background: var(--bg-elevated);
    text-align: center;
    font-size: var(--text-sm);
    font-weight: 500;
  }

  .piece-set-card:hover {
    border-color: var(--color-primary-muted);
    transform: translateY(-1px);
  }

  .piece-set-card.active {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px rgba(79, 109, 122, 0.2);
  }

  .board-color-presets {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
  }

  .board-color-preset {
    width: 40px;
    height: 40px;
    border-radius: var(--radius-md);
    cursor: pointer;
    border: 2px solid var(--border);
    overflow: hidden;
    transition: all 0.15s ease;
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
  }

  .board-color-preset:hover {
    transform: scale(1.1);
  }

  .board-color-preset.active {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px rgba(79, 109, 122, 0.2);
  }

  .board-color-preset .light {
    grid-column: 1;
    grid-row: 1;
  }

  .board-color-preset .dark {
    grid-column: 2;
    grid-row: 2;
  }

  .board-color-preset .light-alt {
    grid-column: 2;
    grid-row: 1;
  }

  .board-color-preset .dark-alt {
    grid-column: 1;
    grid-row: 2;
  }

  .board-custom-colors {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-3);
  }
</style>
{% endblock %}

{% block body %}
<div class="container">
  <a href="/" class="back-link">&larr; Back to Trainer</a>

  <div class="card">
    <h1>Settings</h1>
    <p class="subtitle">Manage your chess usernames</p>

    <div class="alert alert-info visible">
      At least one username is required to continue training.
    </div>

    <div class="alert alert-error" id="errorAlert"></div>
    <div class="alert alert-success" id="successAlert"></div>

    <form id="settingsForm">
      <div class="form-group">
        <label for="lichess">Lichess Username</label>
        <input type="text" id="lichess" name="lichess" placeholder="Enter your Lichess username" value="{{ lichess_username or '' }}">
        <div class="help-text">Optional: Leave blank if you don't use Lichess</div>
      </div>

      <div class="form-group">
        <label for="chesscom">Chess.com Username</label>
        <input type="text" id="chesscom" name="chesscom" placeholder="Enter your Chess.com username" value="{{ chesscom_username or '' }}">
        <div class="help-text">Optional: Leave blank if you don't use Chess.com</div>
      </div>

      <hr style="margin: 32px 0; border: none; border-top: 1px solid var(--border);">

      <h2 style="font-size: 1.25rem; margin-bottom: 16px;">Automatic Sync</h2>

      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="autoSync" name="autoSync" style="width: auto;">
          Enable automatic sync
        </label>
        <div class="help-text">Automatically fetch new games at regular intervals</div>
      </div>

      <div class="form-group">
        <label for="syncInterval">Sync Interval</label>
        <select id="syncInterval" style="width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px;">
          <option value="6">Every 6 hours</option>
          <option value="12">Every 12 hours</option>
          <option value="24" selected>Every 24 hours</option>
          <option value="48">Every 48 hours</option>
        </select>
      </div>

      <div class="form-group">
        <label for="maxGames">Max Games per Sync</label>
        <input type="number" id="maxGames" min="100" max="10000" value="1000" style="width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px;">
        <div class="help-text">Maximum number of games to fetch during each sync</div>
      </div>

      <div class="form-group">
        <label style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="autoAnalyze" name="autoAnalyze" checked style="width: auto;">
          Automatically analyze new games
        </label>
        <div class="help-text">Run analysis on newly fetched games</div>
      </div>

      <hr style="margin: 32px 0; border: none; border-top: 1px solid var(--border);">

      <h2 style="font-size: 1.25rem; margin-bottom: 16px;">Training Settings</h2>

      <div class="form-group">
        <label for="spacedRepetitionDays">Spaced Repetition Interval (days)</label>
        <input type="number" id="spacedRepetitionDays" min="1" max="365" value="30" style="width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px;">
        <div class="help-text">Don't show correctly solved puzzles again for this many days</div>
      </div>

      <hr style="margin: 32px 0; border: none; border-top: 1px solid var(--border);">

      <h2 style="font-size: 1.25rem; margin-bottom: 16px;">Board Appearance</h2>
      <p class="help-text" style="margin-bottom: 16px;">Customize the chessboard colors and piece set.</p>

      <div class="board-preview-container">
        <div class="board-preview" id="boardPreview">
          <!-- 4x4 preview board, will be populated dynamically -->
        </div>

        <div class="board-settings-controls">
          <label class="theme-section-title" style="margin-top: 0;">Piece Set</label>
          <div class="piece-set-grid" id="pieceSetGrid">
            <!-- Piece sets will be loaded dynamically -->
          </div>

          <label class="theme-section-title">Board Colors</label>
          <div class="board-color-presets" id="boardColorPresets">
            <!-- Color presets will be loaded dynamically -->
          </div>

          <div class="board-custom-colors">
            <div class="form-group" style="margin-bottom: 0;">
              <label for="boardLightColor">Light Squares</label>
              <div class="color-input-row">
                <input type="color" id="boardLightColor" value="#f0d9b5">
                <input type="text" id="boardLightHex" value="#f0d9b5" maxlength="7" class="color-hex-input">
              </div>
            </div>
            <div class="form-group" style="margin-bottom: 0;">
              <label for="boardDarkColor">Dark Squares</label>
              <div class="color-input-row">
                <input type="color" id="boardDarkColor" value="#b58863">
                <input type="text" id="boardDarkHex" value="#b58863" maxlength="7" class="color-hex-input">
              </div>
            </div>
          </div>

          <button type="button" class="btn btn-secondary" id="resetBoardBtn" style="margin-top: 12px;">Reset to Defaults</button>
        </div>
      </div>

      <hr style="margin: 32px 0; border: none; border-top: 1px solid var(--border);">

      <h2 style="font-size: 1.25rem; margin-bottom: 16px;">Theme Colors</h2>
      <p class="help-text" style="margin-bottom: 16px;">Choose a preset or customize individual colors.</p>

      <div class="theme-colors">
        <div class="preset-selector">
          <label class="theme-section-title" style="margin-top: 0;">Presets</label>
          <div class="preset-grid" id="presetGrid">
            <!-- Presets will be loaded dynamically -->
          </div>
        </div>

        <h3 class="theme-section-title">Accent Colors</h3>
        <div class="color-grid">
          <div class="form-group">
            <label for="themePrimary">Primary</label>
            <div class="color-input-row">
              <input type="color" id="themePrimary" value="#4f6d7a">
              <input type="text" id="themePrimaryHex" value="#4f6d7a" maxlength="7" class="color-hex-input">
            </div>
            <div class="help-text">Buttons, links, navigation</div>
          </div>

          <div class="form-group">
            <label for="themeSuccess">Success</label>
            <div class="color-input-row">
              <input type="color" id="themeSuccess" value="#3d8b6e">
              <input type="text" id="themeSuccessHex" value="#3d8b6e" maxlength="7" class="color-hex-input">
            </div>
            <div class="help-text">Positive feedback, completed</div>
          </div>

          <div class="form-group">
            <label for="themeError">Error</label>
            <div class="color-input-row">
              <input type="color" id="themeError" value="#c25450">
              <input type="text" id="themeErrorHex" value="#c25450" maxlength="7" class="color-hex-input">
            </div>
            <div class="help-text">Errors, blunder highlighting</div>
          </div>

          <div class="form-group">
            <label for="themeWarning">Warning</label>
            <div class="color-input-row">
              <input type="color" id="themeWarning" value="#b8860b">
              <input type="text" id="themeWarningHex" value="#b8860b" maxlength="7" class="color-hex-input">
            </div>
            <div class="help-text">Warnings, user moves</div>
          </div>
        </div>

        <h3 class="theme-section-title">Game Phase Colors</h3>
        <div class="color-grid">
          <div class="form-group">
            <label for="themePhaseOpening">Opening</label>
            <div class="color-input-row">
              <input type="color" id="themePhaseOpening" value="#5b8a9a">
              <input type="text" id="themePhaseOpeningHex" value="#5b8a9a" maxlength="7" class="color-hex-input">
            </div>
          </div>

          <div class="form-group">
            <label for="themePhaseMiddlegame">Middlegame</label>
            <div class="color-input-row">
              <input type="color" id="themePhaseMiddlegame" value="#9a7b5b">
              <input type="text" id="themePhaseMiddlegameHex" value="#9a7b5b" maxlength="7" class="color-hex-input">
            </div>
          </div>

          <div class="form-group">
            <label for="themePhaseEndgame">Endgame</label>
            <div class="color-input-row">
              <input type="color" id="themePhaseEndgame" value="#7a5b9a">
              <input type="text" id="themePhaseEndgameHex" value="#7a5b9a" maxlength="7" class="color-hex-input">
            </div>
          </div>
        </div>

        <h3 class="theme-section-title">Background & Text</h3>
        <div class="color-grid">
          <div class="form-group">
            <label for="themeBg">Page Background</label>
            <div class="color-input-row">
              <input type="color" id="themeBg" value="#f1f5f9">
              <input type="text" id="themeBgHex" value="#f1f5f9" maxlength="7" class="color-hex-input">
            </div>
          </div>

          <div class="form-group">
            <label for="themeBgCard">Card Background</label>
            <div class="color-input-row">
              <input type="color" id="themeBgCard" value="#ffffff">
              <input type="text" id="themeBgCardHex" value="#ffffff" maxlength="7" class="color-hex-input">
            </div>
          </div>

          <div class="form-group">
            <label for="themeText">Text</label>
            <div class="color-input-row">
              <input type="color" id="themeText" value="#1e293b">
              <input type="text" id="themeTextHex" value="#1e293b" maxlength="7" class="color-hex-input">
            </div>
          </div>

          <div class="form-group">
            <label for="themeTextMuted">Muted Text</label>
            <div class="color-input-row">
              <input type="color" id="themeTextMuted" value="#64748b">
              <input type="text" id="themeTextMutedHex" value="#64748b" maxlength="7" class="color-hex-input">
            </div>
          </div>
        </div>

        <h3 class="theme-section-title">Activity Heatmap</h3>
        <div class="color-grid">
          <div class="form-group">
            <label for="themeHeatmapEmpty">Empty</label>
            <div class="color-input-row">
              <input type="color" id="themeHeatmapEmpty" value="#ebedf0">
              <input type="text" id="themeHeatmapEmptyHex" value="#ebedf0" maxlength="7" class="color-hex-input">
            </div>
          </div>

          <div class="form-group">
            <label for="themeHeatmapL1">Level 1</label>
            <div class="color-input-row">
              <input type="color" id="themeHeatmapL1" value="#9be9a8">
              <input type="text" id="themeHeatmapL1Hex" value="#9be9a8" maxlength="7" class="color-hex-input">
            </div>
          </div>

          <div class="form-group">
            <label for="themeHeatmapL2">Level 2</label>
            <div class="color-input-row">
              <input type="color" id="themeHeatmapL2" value="#40c463">
              <input type="text" id="themeHeatmapL2Hex" value="#40c463" maxlength="7" class="color-hex-input">
            </div>
          </div>

          <div class="form-group">
            <label for="themeHeatmapL3">Level 3</label>
            <div class="color-input-row">
              <input type="color" id="themeHeatmapL3" value="#30a14e">
              <input type="text" id="themeHeatmapL3Hex" value="#30a14e" maxlength="7" class="color-hex-input">
            </div>
          </div>

          <div class="form-group">
            <label for="themeHeatmapL4">Level 4</label>
            <div class="color-input-row">
              <input type="color" id="themeHeatmapL4" value="#216e39">
              <input type="text" id="themeHeatmapL4Hex" value="#216e39" maxlength="7" class="color-hex-input">
            </div>
          </div>
        </div>

        <div class="theme-preview">
          <div class="preview-label">Preview</div>
          <div class="preview-buttons">
            <button type="button" class="btn preview-primary">Primary</button>
            <button type="button" class="btn btn-success preview-success">Success</button>
            <button type="button" class="btn btn-danger preview-error">Error</button>
            <span class="status preview-warning" style="background: var(--color-warning-bg); color: var(--color-warning);">Warning</span>
          </div>
          <div class="preview-phases">
            <span class="phase-pill opening">Opening</span>
            <span class="phase-pill middlegame">Middlegame</span>
            <span class="phase-pill endgame">Endgame</span>
          </div>
          <div class="preview-heatmap">
            <div class="preview-heatmap-label">Activity Heatmap</div>
            <div class="preview-heatmap-grid">
              <div class="preview-heatmap-week">
                <div class="preview-heatmap-cell level-0"></div>
                <div class="preview-heatmap-cell level-1"></div>
                <div class="preview-heatmap-cell level-0"></div>
                <div class="preview-heatmap-cell level-2"></div>
                <div class="preview-heatmap-cell level-0"></div>
                <div class="preview-heatmap-cell level-1"></div>
                <div class="preview-heatmap-cell level-0"></div>
              </div>
              <div class="preview-heatmap-week">
                <div class="preview-heatmap-cell level-1"></div>
                <div class="preview-heatmap-cell level-2"></div>
                <div class="preview-heatmap-cell level-3"></div>
                <div class="preview-heatmap-cell level-1"></div>
                <div class="preview-heatmap-cell level-0"></div>
                <div class="preview-heatmap-cell level-2"></div>
                <div class="preview-heatmap-cell level-1"></div>
              </div>
              <div class="preview-heatmap-week">
                <div class="preview-heatmap-cell level-0"></div>
                <div class="preview-heatmap-cell level-3"></div>
                <div class="preview-heatmap-cell level-4"></div>
                <div class="preview-heatmap-cell level-3"></div>
                <div class="preview-heatmap-cell level-2"></div>
                <div class="preview-heatmap-cell level-1"></div>
                <div class="preview-heatmap-cell level-0"></div>
              </div>
              <div class="preview-heatmap-week">
                <div class="preview-heatmap-cell level-2"></div>
                <div class="preview-heatmap-cell level-4"></div>
                <div class="preview-heatmap-cell level-3"></div>
                <div class="preview-heatmap-cell level-4"></div>
                <div class="preview-heatmap-cell level-2"></div>
                <div class="preview-heatmap-cell level-3"></div>
                <div class="preview-heatmap-cell level-1"></div>
              </div>
              <div class="preview-heatmap-week">
                <div class="preview-heatmap-cell level-1"></div>
                <div class="preview-heatmap-cell level-2"></div>
                <div class="preview-heatmap-cell level-1"></div>
                <div class="preview-heatmap-cell level-3"></div>
                <div class="preview-heatmap-cell level-2"></div>
                <div class="preview-heatmap-cell level-0"></div>
                <div class="preview-heatmap-cell level-1"></div>
              </div>
              <div class="preview-heatmap-week">
                <div class="preview-heatmap-cell level-0"></div>
                <div class="preview-heatmap-cell level-1"></div>
                <div class="preview-heatmap-cell level-0"></div>
                <div class="preview-heatmap-cell level-2"></div>
                <div class="preview-heatmap-cell level-1"></div>
                <div class="preview-heatmap-cell level-0"></div>
                <div class="preview-heatmap-cell level-0"></div>
              </div>
            </div>
          </div>
        </div>

        <button type="button" class="btn btn-secondary" id="resetThemeBtn" style="margin-top: 12px;">Reset to Defaults</button>
      </div>

      <div class="btn-row" style="margin-top: 32px;">
        <button type="button" class="btn btn-secondary" onclick="window.location.href='/'">Cancel</button>
        <button type="submit" class="btn btn-primary" id="submitBtn">Save Changes</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  const form = document.getElementById('settingsForm');
  const errorAlert = document.getElementById('errorAlert');
  const successAlert = document.getElementById('successAlert');
  const submitBtn = document.getElementById('submitBtn');
  const lichessInput = document.getElementById('lichess');
  const chesscomInput = document.getElementById('chesscom');

  function showError(message) {
    errorAlert.textContent = message;
    errorAlert.classList.add('visible');
    successAlert.classList.remove('visible');
  }

  function showSuccess(message) {
    successAlert.textContent = message;
    successAlert.classList.add('visible');
    errorAlert.classList.remove('visible');
  }

  function hideAlerts() {
    errorAlert.classList.remove('visible');
    successAlert.classList.remove('visible');
  }

  // Theme color inputs - maps to API field names
  const themeInputs = {
    primary: { color: document.getElementById('themePrimary'), hex: document.getElementById('themePrimaryHex') },
    success: { color: document.getElementById('themeSuccess'), hex: document.getElementById('themeSuccessHex') },
    error: { color: document.getElementById('themeError'), hex: document.getElementById('themeErrorHex') },
    warning: { color: document.getElementById('themeWarning'), hex: document.getElementById('themeWarningHex') },
    phase_opening: { color: document.getElementById('themePhaseOpening'), hex: document.getElementById('themePhaseOpeningHex') },
    phase_middlegame: { color: document.getElementById('themePhaseMiddlegame'), hex: document.getElementById('themePhaseMiddlegameHex') },
    phase_endgame: { color: document.getElementById('themePhaseEndgame'), hex: document.getElementById('themePhaseEndgameHex') },
    bg: { color: document.getElementById('themeBg'), hex: document.getElementById('themeBgHex') },
    bg_card: { color: document.getElementById('themeBgCard'), hex: document.getElementById('themeBgCardHex') },
    text: { color: document.getElementById('themeText'), hex: document.getElementById('themeTextHex') },
    text_muted: { color: document.getElementById('themeTextMuted'), hex: document.getElementById('themeTextMutedHex') },
    heatmap_empty: { color: document.getElementById('themeHeatmapEmpty'), hex: document.getElementById('themeHeatmapEmptyHex') },
    heatmap_l1: { color: document.getElementById('themeHeatmapL1'), hex: document.getElementById('themeHeatmapL1Hex') },
    heatmap_l2: { color: document.getElementById('themeHeatmapL2'), hex: document.getElementById('themeHeatmapL2Hex') },
    heatmap_l3: { color: document.getElementById('themeHeatmapL3'), hex: document.getElementById('themeHeatmapL3Hex') },
    heatmap_l4: { color: document.getElementById('themeHeatmapL4'), hex: document.getElementById('themeHeatmapL4Hex') }
  };

  const defaultTheme = {
    primary: '#4f6d7a',
    success: '#3d8b6e',
    error: '#c25450',
    warning: '#b8860b',
    phase_opening: '#5b8a9a',
    phase_middlegame: '#9a7b5b',
    phase_endgame: '#7a5b9a',
    bg: '#f1f5f9',
    bg_card: '#ffffff',
    text: '#1e293b',
    text_muted: '#64748b',
    heatmap_empty: '#ebedf0',
    heatmap_l1: '#9be9a8',
    heatmap_l2: '#40c463',
    heatmap_l3: '#30a14e',
    heatmap_l4: '#216e39'
  };

  let themePresets = [];
  let activePresetId = null;

  // Sync color picker with hex input and update preview
  function setupColorSync(name) {
    const { color, hex } = themeInputs[name];
    
    color.addEventListener('input', () => {
      hex.value = color.value.toUpperCase();
      updateThemePreview();
      clearActivePreset();
    });
    
    hex.addEventListener('input', () => {
      const val = hex.value;
      if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
        color.value = val;
        updateThemePreview();
        clearActivePreset();
      }
    });

    hex.addEventListener('blur', () => {
      let val = hex.value.trim();
      if (!val.startsWith('#')) val = '#' + val;
      if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
        hex.value = val.toUpperCase();
        color.value = val;
      } else {
        hex.value = color.value.toUpperCase();
      }
    });
  }

  function clearActivePreset() {
    activePresetId = null;
    document.querySelectorAll('.preset-card').forEach(card => {
      card.classList.remove('active');
    });
  }

  // Update live preview
  function updateThemePreview() {
    const root = document.documentElement;
    const theme = getCurrentTheme();
    
    // Core colors
    root.style.setProperty('--color-primary', theme.primary);
    root.style.setProperty('--color-success', theme.success);
    root.style.setProperty('--color-error', theme.error);
    root.style.setProperty('--color-warning', theme.warning);
    
    // Phase colors
    root.style.setProperty('--color-phase-opening', theme.phase_opening);
    root.style.setProperty('--color-phase-middlegame', theme.phase_middlegame);
    root.style.setProperty('--color-phase-endgame', theme.phase_endgame);
    
    // Background and text
    root.style.setProperty('--bg', theme.bg);
    root.style.setProperty('--bg-elevated', theme.bg_card);
    root.style.setProperty('--text', theme.text);
    root.style.setProperty('--text-muted', theme.text_muted);
    
    // Heatmap colors
    root.style.setProperty('--heatmap-empty', theme.heatmap_empty);
    root.style.setProperty('--heatmap-l1', theme.heatmap_l1);
    root.style.setProperty('--heatmap-l2', theme.heatmap_l2);
    root.style.setProperty('--heatmap-l3', theme.heatmap_l3);
    root.style.setProperty('--heatmap-l4', theme.heatmap_l4);
    
    // Update derived colors
    if (window.adjustColor) {
      root.style.setProperty('--color-primary-hover', window.adjustColor(theme.primary, -15));
      root.style.setProperty('--color-primary-muted', window.adjustColor(theme.primary, 20));
      root.style.setProperty('--color-success-bg', window.adjustColor(theme.success, 85, 0.15));
      root.style.setProperty('--color-success-border', window.adjustColor(theme.success, 50, 0.4));
      root.style.setProperty('--color-error-bg', window.adjustColor(theme.error, 85, 0.15));
      root.style.setProperty('--color-error-border', window.adjustColor(theme.error, 50, 0.4));
      root.style.setProperty('--color-warning-bg', window.adjustColor(theme.warning, 85, 0.15));
      root.style.setProperty('--color-warning-border', window.adjustColor(theme.warning, 50, 0.4));
    }
  }

  function getCurrentTheme() {
    const theme = {};
    for (const [name, inputs] of Object.entries(themeInputs)) {
      theme[name] = inputs.hex.value;
    }
    return theme;
  }

  function setThemeInputs(theme) {
    for (const [name, value] of Object.entries(theme)) {
      if (themeInputs[name]) {
        themeInputs[name].color.value = value;
        themeInputs[name].hex.value = value.toUpperCase();
      }
    }
    updateThemePreview();
  }

  // Setup color syncing
  Object.keys(themeInputs).forEach(setupColorSync);

  // Load and render presets
  async function loadPresets() {
    try {
      const resp = await fetch('/api/settings/theme/presets');
      if (resp.ok) {
        const data = await resp.json();
        themePresets = data.presets;
        renderPresets();
      }
    } catch (err) {
      console.error('Failed to load presets:', err);
    }
  }

  function renderPresets() {
    const grid = document.getElementById('presetGrid');
    grid.innerHTML = themePresets.map(preset => `
      <div class="preset-card ${activePresetId === preset.id ? 'active' : ''}" data-preset-id="${preset.id}">
        <div class="preset-colors">
          <span class="preset-color-dot" style="background: ${preset.colors.primary}"></span>
          <span class="preset-color-dot" style="background: ${preset.colors.success}"></span>
          <span class="preset-color-dot" style="background: ${preset.colors.error}"></span>
          <span class="preset-color-dot" style="background: ${preset.colors.bg}"></span>
        </div>
        <div class="preset-name">${preset.name}</div>
      </div>
    `).join('');

    // Add click handlers
    grid.querySelectorAll('.preset-card').forEach(card => {
      card.addEventListener('click', () => {
        const presetId = card.dataset.presetId;
        applyPreset(presetId);
      });
    });
  }

  function applyPreset(presetId) {
    const preset = themePresets.find(p => p.id === presetId);
    if (!preset) return;

    activePresetId = presetId;
    setThemeInputs(preset.colors);
    
    // Update active state in UI
    document.querySelectorAll('.preset-card').forEach(card => {
      card.classList.toggle('active', card.dataset.presetId === presetId);
    });
  }

  function checkIfMatchesPreset() {
    const currentTheme = getCurrentTheme();
    for (const preset of themePresets) {
      const matches = Object.keys(currentTheme).every(
        key => currentTheme[key].toLowerCase() === preset.colors[key].toLowerCase()
      );
      if (matches) {
        activePresetId = preset.id;
        return;
      }
    }
    activePresetId = null;
  }

  // Reset theme button
  document.getElementById('resetThemeBtn').addEventListener('click', async () => {
    applyPreset('default');
  });

  // Load sync settings and theme
  async function loadSyncSettings() {
    try {
      // Load presets first
      await loadPresets();

      // Load theme colors
      const themeResp = await fetch('/api/settings/theme');
      if (themeResp.ok) {
        const theme = await themeResp.json();
        setThemeInputs(theme);
        checkIfMatchesPreset();
        renderPresets(); // Re-render to show active state
      }

      // Load all settings from API
      const settingsResp = await fetch('/api/settings');
      if (settingsResp.ok) {
        const settings = await settingsResp.json();
        document.getElementById('autoSync').checked = settings.auto_sync;
        document.getElementById('syncInterval').value = String(settings.sync_interval);
        document.getElementById('maxGames').value = String(settings.max_games);
        document.getElementById('autoAnalyze').checked = settings.auto_analyze;
        document.getElementById('spacedRepetitionDays').value = String(settings.spaced_repetition_days);
      }
    } catch (err) {
      console.error('Failed to load settings:', err);
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideAlerts();

    const lichess = lichessInput.value.trim();
    const chesscom = chesscomInput.value.trim();

    // Validate at least one username
    if (!lichess && !chesscom) {
      showError('Please provide at least one username (Lichess or Chess.com)');
      return;
    }

    // Get sync settings
    const autoSync = document.getElementById('autoSync').checked;
    const syncInterval = document.getElementById('syncInterval').value;
    const maxGames = document.getElementById('maxGames').value;
    const autoAnalyze = document.getElementById('autoAnalyze').checked;
    const spacedRepetitionDays = document.getElementById('spacedRepetitionDays').value;

    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';

    try {
      const theme = getCurrentTheme();
      
      const response = await fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          lichess,
          chesscom,
          auto_sync: autoSync,
          sync_interval: syncInterval,
          max_games: maxGames,
          auto_analyze: autoAnalyze,
          spaced_repetition_days: spacedRepetitionDays,
          theme
        })
      });
      
      // Update localStorage with new theme
      localStorage.setItem('theme', JSON.stringify(theme));

      const data = await response.json();

      if (response.ok) {
        showSuccess('Settings saved successfully!');
        setTimeout(() => {
          window.location.href = '/';
        }, 1500);
      } else {
        showError(data.error || 'Failed to save settings. Please try again.');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Save Changes';
      }
    } catch (err) {
      showError('Network error. Please try again.');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Save Changes';
      console.error(err);
    }
  });

  // ==================== Board Settings ====================
  
  // Board settings state
  let pieceSets = [];
  let boardColorPresets = [];
  let currentPieceSet = 'wikipedia';
  let currentBoardLight = '#f0d9b5';
  let currentBoardDark = '#b58863';
  let activeBoardColorPreset = null;

  // Board settings DOM elements
  const boardPreview = document.getElementById('boardPreview');
  const pieceSetGrid = document.getElementById('pieceSetGrid');
  const boardColorPresetsEl = document.getElementById('boardColorPresets');
  const boardLightColor = document.getElementById('boardLightColor');
  const boardLightHex = document.getElementById('boardLightHex');
  const boardDarkColor = document.getElementById('boardDarkColor');
  const boardDarkHex = document.getElementById('boardDarkHex');
  const resetBoardBtn = document.getElementById('resetBoardBtn');

  // Preview board pieces (simplified 4x4)
  const previewPieces = [
    ['bR', null, 'bB', 'bK'],
    [null, 'bP', null, 'bP'],
    ['wP', null, 'wN', null],
    ['wR', null, 'wB', 'wK']
  ];

  function getPieceImageUrl(piece) {
    if (!piece) return null;
    const format = currentPieceSet === 'wikipedia' ? 'png' : 'svg';
    return `/static/pieces/${currentPieceSet}/${piece}.${format}`;
  }

  function renderBoardPreview() {
    const root = document.documentElement;
    root.style.setProperty('--preview-board-light', currentBoardLight);
    root.style.setProperty('--preview-board-dark', currentBoardDark);

    let html = '';
    for (let row = 0; row < 4; row++) {
      for (let col = 0; col < 4; col++) {
        const isLight = (row + col) % 2 === 0;
        const piece = previewPieces[row][col];
        const pieceImg = piece ? `<img src="${getPieceImageUrl(piece)}" alt="${piece}">` : '';
        html += `<div class="square ${isLight ? 'light' : 'dark'}">${pieceImg}</div>`;
      }
    }
    boardPreview.innerHTML = html;
  }

  function renderPieceSetGrid() {
    pieceSetGrid.innerHTML = pieceSets.map(ps => `
      <div class="piece-set-card ${currentPieceSet === ps.id ? 'active' : ''}" data-piece-set="${ps.id}">
        ${ps.name}
      </div>
    `).join('');

    pieceSetGrid.querySelectorAll('.piece-set-card').forEach(card => {
      card.addEventListener('click', () => {
        currentPieceSet = card.dataset.pieceSet;
        renderPieceSetGrid();
        renderBoardPreview();
      });
    });
  }

  function renderBoardColorPresets() {
    boardColorPresetsEl.innerHTML = boardColorPresets.map(preset => `
      <div class="board-color-preset ${activeBoardColorPreset === preset.id ? 'active' : ''}" 
           data-preset-id="${preset.id}" 
           data-light="${preset.light}" 
           data-dark="${preset.dark}"
           title="${preset.name}">
        <div class="light" style="background: ${preset.light};"></div>
        <div class="light-alt" style="background: ${preset.dark};"></div>
        <div class="dark-alt" style="background: ${preset.light};"></div>
        <div class="dark" style="background: ${preset.dark};"></div>
      </div>
    `).join('');

    boardColorPresetsEl.querySelectorAll('.board-color-preset').forEach(preset => {
      preset.addEventListener('click', () => {
        const light = preset.dataset.light;
        const dark = preset.dataset.dark;
        const presetId = preset.dataset.presetId;
        
        currentBoardLight = light;
        currentBoardDark = dark;
        activeBoardColorPreset = presetId;
        
        boardLightColor.value = light;
        boardLightHex.value = light.toUpperCase();
        boardDarkColor.value = dark;
        boardDarkHex.value = dark.toUpperCase();
        
        renderBoardColorPresets();
        renderBoardPreview();
      });
    });
  }

  function clearActiveBoardColorPreset() {
    activeBoardColorPreset = null;
    boardColorPresetsEl.querySelectorAll('.board-color-preset').forEach(el => {
      el.classList.remove('active');
    });
  }

  function checkIfMatchesBoardColorPreset() {
    for (const preset of boardColorPresets) {
      if (preset.light.toLowerCase() === currentBoardLight.toLowerCase() &&
          preset.dark.toLowerCase() === currentBoardDark.toLowerCase()) {
        activeBoardColorPreset = preset.id;
        return;
      }
    }
    activeBoardColorPreset = null;
  }

  // Setup board color inputs sync
  function setupBoardColorSync(colorInput, hexInput, isLight) {
    colorInput.addEventListener('input', () => {
      hexInput.value = colorInput.value.toUpperCase();
      if (isLight) {
        currentBoardLight = colorInput.value;
      } else {
        currentBoardDark = colorInput.value;
      }
      clearActiveBoardColorPreset();
      renderBoardPreview();
    });

    hexInput.addEventListener('input', () => {
      const val = hexInput.value;
      if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
        colorInput.value = val;
        if (isLight) {
          currentBoardLight = val;
        } else {
          currentBoardDark = val;
        }
        clearActiveBoardColorPreset();
        renderBoardPreview();
      }
    });

    hexInput.addEventListener('blur', () => {
      let val = hexInput.value.trim();
      if (!val.startsWith('#')) val = '#' + val;
      if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
        hexInput.value = val.toUpperCase();
        colorInput.value = val;
      } else {
        hexInput.value = colorInput.value.toUpperCase();
      }
    });
  }

  setupBoardColorSync(boardLightColor, boardLightHex, true);
  setupBoardColorSync(boardDarkColor, boardDarkHex, false);

  // Reset board settings
  resetBoardBtn.addEventListener('click', async () => {
    currentPieceSet = 'wikipedia';
    currentBoardLight = '#f0d9b5';
    currentBoardDark = '#b58863';
    
    boardLightColor.value = currentBoardLight;
    boardLightHex.value = currentBoardLight.toUpperCase();
    boardDarkColor.value = currentBoardDark;
    boardDarkHex.value = currentBoardDark.toUpperCase();
    
    checkIfMatchesBoardColorPreset();
    renderPieceSetGrid();
    renderBoardColorPresets();
    renderBoardPreview();
  });

  // Load board settings
  async function loadBoardSettings() {
    try {
      // Load piece sets
      const pieceSetsResp = await fetch('/api/settings/board/piece-sets');
      if (pieceSetsResp.ok) {
        const data = await pieceSetsResp.json();
        pieceSets = data.piece_sets;
      }

      // Load color presets
      const colorPresetsResp = await fetch('/api/settings/board/color-presets');
      if (colorPresetsResp.ok) {
        const data = await colorPresetsResp.json();
        boardColorPresets = data.presets;
      }

      // Load current settings
      const boardResp = await fetch('/api/settings/board');
      if (boardResp.ok) {
        const settings = await boardResp.json();
        currentPieceSet = settings.piece_set;
        currentBoardLight = settings.board_light;
        currentBoardDark = settings.board_dark;
        
        boardLightColor.value = currentBoardLight;
        boardLightHex.value = currentBoardLight.toUpperCase();
        boardDarkColor.value = currentBoardDark;
        boardDarkHex.value = currentBoardDark.toUpperCase();
      }

      checkIfMatchesBoardColorPreset();
      renderPieceSetGrid();
      renderBoardColorPresets();
      renderBoardPreview();
    } catch (err) {
      console.error('Failed to load board settings:', err);
    }
  }

  // Save board settings (called from form submit)
  async function saveBoardSettings() {
    try {
      await fetch('/api/settings/board', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          piece_set: currentPieceSet,
          board_light: currentBoardLight,
          board_dark: currentBoardDark
        })
      });
    } catch (err) {
      console.error('Failed to save board settings:', err);
    }
  }

  // Modify the form submit to also save board settings
  const originalFormSubmit = form.onsubmit;
  form.addEventListener('submit', async (e) => {
    // Board settings are saved separately
    await saveBoardSettings();
  });

  // Load settings on page load
  loadSyncSettings();
  loadBoardSettings();
</script>
{% endblock %}
