<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>{% block title %}Blunder Tutor{% endblock %}</title>

  <!-- Base CSS -->
  <link rel="stylesheet" href="/static/css/base.css">

  <!-- Theme loader - applies custom colors before page renders -->
  <script>
    (function() {
      // Try to load theme from localStorage first for instant apply
      const cached = localStorage.getItem('theme');
      if (cached) {
        try {
          const theme = JSON.parse(cached);
          applyTheme(theme);
        } catch (e) {}
      }

      function applyTheme(theme) {
        const root = document.documentElement;
        
        // Core accent colors
        if (theme.primary) {
          root.style.setProperty('--color-primary', theme.primary);
          root.style.setProperty('--color-primary-hover', adjustColor(theme.primary, -15));
          root.style.setProperty('--color-primary-muted', adjustColor(theme.primary, 20));
        }
        if (theme.success) {
          root.style.setProperty('--color-success', theme.success);
          root.style.setProperty('--color-success-bg', adjustColor(theme.success, 85, 0.15));
          root.style.setProperty('--color-success-border', adjustColor(theme.success, 50, 0.4));
        }
        if (theme.error) {
          root.style.setProperty('--color-error', theme.error);
          root.style.setProperty('--color-error-bg', adjustColor(theme.error, 85, 0.15));
          root.style.setProperty('--color-error-border', adjustColor(theme.error, 50, 0.4));
        }
        if (theme.warning) {
          root.style.setProperty('--color-warning', theme.warning);
          root.style.setProperty('--color-warning-bg', adjustColor(theme.warning, 85, 0.15));
          root.style.setProperty('--color-warning-border', adjustColor(theme.warning, 50, 0.4));
        }
        
        // Phase colors
        if (theme.phase_opening) root.style.setProperty('--color-phase-opening', theme.phase_opening);
        if (theme.phase_middlegame) root.style.setProperty('--color-phase-middlegame', theme.phase_middlegame);
        if (theme.phase_endgame) root.style.setProperty('--color-phase-endgame', theme.phase_endgame);
        
        // Heatmap colors
        if (theme.heatmap_empty) root.style.setProperty('--heatmap-empty', theme.heatmap_empty);
        if (theme.heatmap_l1) root.style.setProperty('--heatmap-l1', theme.heatmap_l1);
        if (theme.heatmap_l2) root.style.setProperty('--heatmap-l2', theme.heatmap_l2);
        if (theme.heatmap_l3) root.style.setProperty('--heatmap-l3', theme.heatmap_l3);
        if (theme.heatmap_l4) root.style.setProperty('--heatmap-l4', theme.heatmap_l4);
        
        // Background and text
        if (theme.bg) root.style.setProperty('--bg', theme.bg);
        if (theme.bg_card) root.style.setProperty('--bg-elevated', theme.bg_card);
        if (theme.text) root.style.setProperty('--text', theme.text);
        if (theme.text_muted) root.style.setProperty('--text-muted', theme.text_muted);
      }

      function adjustColor(hex, lightness, saturation) {
        // Simple color adjustment - convert to HSL, adjust, convert back
        const r = parseInt(hex.slice(1, 3), 16) / 255;
        const g = parseInt(hex.slice(3, 5), 16) / 255;
        const b = parseInt(hex.slice(5, 7), 16) / 255;
        const max = Math.max(r, g, b), min = Math.min(r, g, b);
        let h, s, l = (max + min) / 2;

        if (max === min) {
          h = s = 0;
        } else {
          const d = max - min;
          s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
          switch (max) {
            case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
            case g: h = ((b - r) / d + 2) / 6; break;
            case b: h = ((r - g) / d + 4) / 6; break;
          }
        }

        // Adjust lightness (lightness param is target %)
        if (typeof lightness === 'number') {
          l = lightness / 100;
        }
        if (typeof saturation === 'number') {
          s = saturation;
        }

        // HSL to RGB
        function hue2rgb(p, q, t) {
          if (t < 0) t += 1;
          if (t > 1) t -= 1;
          if (t < 1/6) return p + (q - p) * 6 * t;
          if (t < 1/2) return q;
          if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
          return p;
        }

        let r2, g2, b2;
        if (s === 0) {
          r2 = g2 = b2 = l;
        } else {
          const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
          const p = 2 * l - q;
          r2 = hue2rgb(p, q, h + 1/3);
          g2 = hue2rgb(p, q, h);
          b2 = hue2rgb(p, q, h - 1/3);
        }

        const toHex = x => Math.round(x * 255).toString(16).padStart(2, '0');
        return `#${toHex(r2)}${toHex(g2)}${toHex(b2)}`;
      }

      // Expose for later use
      window.adjustColor = adjustColor;
      window.applyTheme = applyTheme;
    })();
  </script>

  <!-- HTMX for reactive components -->
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>

  <!-- Page-specific CSS -->
  {% block extra_css %}{% endblock %}

  <!-- Page-specific head content -->
  {% block extra_head %}{% endblock %}
</head>
<body>
  {% block body %}
  <div class="container">
    {% block header %}
    <h1>{% block page_title %}Blunder Tutor{% endblock %}</h1>
    {% endblock %}

    {% block navigation %}{% endblock %}

    {% block content %}{% endblock %}
  </div>
  {% endblock %}

  <!-- Base JavaScript (jQuery for chessboard, if needed) -->
  {% block base_scripts %}{% endblock %}

  <!-- WebSocket client for real-time updates -->
  <script src="/static/js/websocket-client.js"></script>

  <!-- Theme sync - fetch from server and update cache -->
  <script>
    (function() {
      fetch('/api/settings/theme')
        .then(r => r.json())
        .then(theme => {
          localStorage.setItem('theme', JSON.stringify(theme));
          if (window.applyTheme) {
            window.applyTheme(theme);
          }
        })
        .catch(() => {});
    })();
  </script>

  <!-- Page-specific JavaScript -->
  {% block extra_scripts %}{% endblock %}
</body>
</html>
