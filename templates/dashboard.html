{% extends "base.html" %}
{% from "_nav.html" import render_nav %}

{% block title %}Dashboard - Blunder Tutor{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block extra_css %}
<style>
  /* Dashboard-specific: chart canvas heights */
  .chart-canvas-container {
    position: relative;
    height: 300px;
  }

  .chart-empty-state {
    display: none;
    text-align: center;
    padding: var(--space-10);
    color: var(--text-muted);
  }

  .chart-description {
    font-size: var(--text-sm);
    color: var(--text-muted);
    margin-bottom: var(--space-4);
  }

  .loading-placeholder {
    text-align: center;
    padding: var(--space-5);
    color: var(--text-muted);
  }

  /* Tactical pattern styles */
  .tactical-bar-container {
    margin-bottom: var(--space-4);
  }

  .tactical-bar {
    display: flex;
    height: 24px;
    border-radius: var(--radius);
    overflow: hidden;
  }

  .tactical-bar-segment {
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: var(--text-xs);
    font-weight: 600;
    transition: flex 0.3s ease;
  }

  .tactical-bar-segment.fork { background: #ef4444; }
  .tactical-bar-segment.pin { background: #8b5cf6; }
  .tactical-bar-segment.skewer { background: #06b6d4; }
  .tactical-bar-segment.discovered { background: #f59e0b; }
  .tactical-bar-segment.hanging { background: #ec4899; }
  .tactical-bar-segment.back_rank { background: #10b981; }
  .tactical-bar-segment.other { background: #6b7280; }

  .tactical-legend {
    display: flex;
    gap: var(--space-4);
    flex-wrap: wrap;
    margin-top: var(--space-2);
  }

  .tactical-legend-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-xs);
    color: var(--text-muted);
  }

  .tactical-legend-color {
    width: 12px;
    height: 12px;
    border-radius: var(--radius-sm);
  }

  .tactical-legend-color.fork { background: #ef4444; }
  .tactical-legend-color.pin { background: #8b5cf6; }
  .tactical-legend-color.skewer { background: #06b6d4; }
  .tactical-legend-color.discovered { background: #f59e0b; }
  .tactical-legend-color.hanging { background: #ec4899; }
  .tactical-legend-color.back_rank { background: #10b981; }
  .tactical-legend-color.other { background: #6b7280; }

  .tactical-breakdown {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: var(--space-3);
  }

  .tactical-card {
    padding: var(--space-4);
    border-radius: var(--radius);
    text-align: center;
    border: 1px solid var(--border);
  }

  .tactical-card.fork { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); }
  .tactical-card.pin { background: rgba(139, 92, 246, 0.1); border-color: rgba(139, 92, 246, 0.3); }
  .tactical-card.skewer { background: rgba(6, 182, 212, 0.1); border-color: rgba(6, 182, 212, 0.3); }
  .tactical-card.discovered { background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.3); }
  .tactical-card.hanging { background: rgba(236, 72, 153, 0.1); border-color: rgba(236, 72, 153, 0.3); }
  .tactical-card.back_rank { background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.3); }
  .tactical-card.other { background: rgba(107, 114, 128, 0.1); border-color: rgba(107, 114, 128, 0.3); }

  .tactical-name {
    font-weight: 600;
    text-transform: capitalize;
    margin-bottom: var(--space-1);
    font-size: var(--text-sm);
  }

  .tactical-card.fork .tactical-name { color: #ef4444; }
  .tactical-card.pin .tactical-name { color: #8b5cf6; }
  .tactical-card.skewer .tactical-name { color: #06b6d4; }
  .tactical-card.discovered .tactical-name { color: #f59e0b; }
  .tactical-card.hanging .tactical-name { color: #ec4899; }
  .tactical-card.back_rank .tactical-name { color: #10b981; }
  .tactical-card.other .tactical-name { color: #6b7280; }

  .tactical-count {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--text);
  }

  .tactical-percent {
    font-size: var(--text-xs);
    color: var(--text-muted);
  }

  /* Game type styles */
  .game-type-bar-container {
    margin-bottom: var(--space-4);
  }

  .game-type-bar {
    display: flex;
    height: 24px;
    border-radius: var(--radius);
    overflow: hidden;
  }

  .game-type-bar-segment {
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: var(--text-xs);
    font-weight: 600;
    transition: flex 0.3s ease;
  }

  .game-type-bar-segment.ultrabullet { background: #dc2626; }
  .game-type-bar-segment.bullet { background: #f97316; }
  .game-type-bar-segment.blitz { background: #eab308; }
  .game-type-bar-segment.rapid { background: #22c55e; }
  .game-type-bar-segment.classical { background: #3b82f6; }
  .game-type-bar-segment.correspondence { background: #8b5cf6; }

  .game-type-legend {
    display: flex;
    gap: var(--space-4);
    flex-wrap: wrap;
    margin-top: var(--space-2);
  }

  .game-type-legend-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-xs);
    color: var(--text-muted);
  }

  .game-type-legend-color {
    width: 12px;
    height: 12px;
    border-radius: var(--radius-sm);
  }

  .game-type-legend-color.ultrabullet { background: #dc2626; }
  .game-type-legend-color.bullet { background: #f97316; }
  .game-type-legend-color.blitz { background: #eab308; }
  .game-type-legend-color.rapid { background: #22c55e; }
  .game-type-legend-color.classical { background: #3b82f6; }
  .game-type-legend-color.correspondence { background: #8b5cf6; }

  .game-type-breakdown {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: var(--space-3);
  }

  .game-type-card {
    padding: var(--space-4);
    border-radius: var(--radius);
    text-align: center;
    border: 1px solid var(--border);
  }

  .game-type-card.ultrabullet { background: rgba(220, 38, 38, 0.1); border-color: rgba(220, 38, 38, 0.3); }
  .game-type-card.bullet { background: rgba(249, 115, 22, 0.1); border-color: rgba(249, 115, 22, 0.3); }
  .game-type-card.blitz { background: rgba(234, 179, 8, 0.1); border-color: rgba(234, 179, 8, 0.3); }
  .game-type-card.rapid { background: rgba(34, 197, 94, 0.1); border-color: rgba(34, 197, 94, 0.3); }
  .game-type-card.classical { background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3); }
  .game-type-card.correspondence { background: rgba(139, 92, 246, 0.1); border-color: rgba(139, 92, 246, 0.3); }

  .game-type-name {
    font-weight: 600;
    text-transform: capitalize;
    margin-bottom: var(--space-1);
    font-size: var(--text-sm);
  }

  .game-type-card.ultrabullet .game-type-name { color: #dc2626; }
  .game-type-card.bullet .game-type-name { color: #f97316; }
  .game-type-card.blitz .game-type-name { color: #eab308; }
  .game-type-card.rapid .game-type-name { color: #22c55e; }
  .game-type-card.classical .game-type-name { color: #3b82f6; }
  .game-type-card.correspondence .game-type-name { color: #8b5cf6; }

  .game-type-count {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--text);
  }

  .game-type-percent {
    font-size: var(--text-xs);
    color: var(--text-muted);
  }

  /* Heatmap styles */
  .heatmap-wrapper {
    padding: var(--space-4);
  }

  .heatmap-summary {
    display: flex;
    gap: var(--space-4);
    margin-bottom: var(--space-4);
    font-size: var(--text-sm);
  }

  .heatmap-total {
    font-weight: 600;
    color: var(--text);
  }

  .heatmap-days {
    color: var(--text-muted);
  }

  .heatmap-container {
    display: flex;
    gap: var(--space-2);
    overflow-x: auto;
  }

  .heatmap-days-labels {
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    padding-top: 20px;
    font-size: 10px;
    color: var(--text-muted);
  }

  .heatmap-grid-wrapper {
    flex: 1;
    min-width: 0;
  }

  .heatmap-months {
    display: grid;
    font-size: 10px;
    color: var(--text-muted);
    margin-bottom: 4px;
    height: 16px;
  }

  .heatmap-grid {
    display: grid;
    gap: 3px;
  }

  .heatmap-week {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }

  .heatmap-cell {
    width: 12px;
    height: 12px;
    border-radius: 2px;
    cursor: pointer;
  }

  .heatmap-cell.empty {
    visibility: hidden;
  }

  .heatmap-cell.level-0 { background: var(--heatmap-empty, #ebedf0); }
  .heatmap-cell.level-1 { background: var(--heatmap-l1, #9be9a8); }
  .heatmap-cell.level-2 { background: var(--heatmap-l2, #40c463); }
  .heatmap-cell.level-3 { background: var(--heatmap-l3, #30a14e); }
  .heatmap-cell.level-4 { background: var(--heatmap-l4, #216e39); }

  .heatmap-legend {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    margin-top: var(--space-3);
    font-size: 10px;
    color: var(--text-muted);
    justify-content: flex-end;
  }

  .heatmap-legend .heatmap-cell {
    cursor: default;
  }

  .heatmap-error {
    text-align: center;
    padding: var(--space-5);
    color: var(--text-muted);
  }

  /* Custom instant tooltip */
  .heatmap-cell[data-tooltip] {
    position: relative;
  }

  .heatmap-cell[data-tooltip]:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: calc(100% + 6px);
    left: 50%;
    transform: translateX(-50%);
    padding: 4px 8px;
    background: var(--text, #1e293b);
    color: var(--bg-card, #fff);
    font-size: 11px;
    white-space: nowrap;
    border-radius: 4px;
    z-index: 100;
    pointer-events: none;
  }

  .heatmap-cell[data-tooltip]:hover::before {
    content: '';
    position: absolute;
    bottom: calc(100% + 2px);
    left: 50%;
    transform: translateX(-50%);
    border: 4px solid transparent;
    border-top-color: var(--text, #1e293b);
    z-index: 100;
  }
</style>
{% endblock %}

{% block content %}
<h1>Blunder Tutor Dashboard</h1>
{{ render_nav('dashboard') }}

<div class="dashboard-filters">
  <div class="filter-group">
    <label for="dateFrom">From:</label>
    <input type="date" id="dateFrom" name="date_from">
  </div>
  <div class="filter-group">
    <label for="dateTo">To:</label>
    <input type="date" id="dateTo" name="date_to">
  </div>
  <div class="filter-group">
    <button class="btn" onclick="applyDateFilter()">Apply</button>
    <button class="btn btn-secondary" onclick="clearDateFilter()">Clear</button>
  </div>
  <div class="filter-presets">
    <button data-preset="7d" onclick="setPreset('7d')">Last 7 days</button>
    <button data-preset="30d" onclick="setPreset('30d')">Last 30 days</button>
    <button data-preset="90d" onclick="setPreset('90d')">Last 90 days</button>
    <button data-preset="1y" onclick="setPreset('1y')">Last year</button>
    <button data-preset="all" onclick="setPreset('all')" class="active">All time</button>
  </div>
</div>

<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-label">Total Games</div>
    <div class="stat-value" id="totalGames">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Analyzed Games</div>
    <div class="stat-value" id="analyzedGames">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Total Blunders</div>
    <div class="stat-value" id="totalBlunders">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Analysis Progress</div>
    <div class="stat-value" id="progressPercent">-</div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
    <div id="analysisJobStatus" class="text-sm text-muted mt-2"></div>
  </div>
</div>

<div class="chart-container">
  <div class="chart-title">Puzzle Activity</div>
  <p class="chart-description">Your puzzle solving activity over the past year.</p>
  <div id="activityHeatmap">
    <div class="loading-placeholder">Loading activity data...</div>
  </div>
</div>

<div class="chart-container">
  <div class="chart-title">Blunders by Game Phase</div>
  <p class="chart-description">Understand where in your games you tend to make mistakes.</p>
  <div class="phase-bar-container" id="phaseBarContainer" style="display: none;">
    <div class="phase-bar" id="phaseBar"></div>
    <div class="phase-legend">
      <div class="phase-legend-item">
        <span class="phase-legend-color opening"></span>
        <span>Opening</span>
      </div>
      <div class="phase-legend-item">
        <span class="phase-legend-color middlegame"></span>
        <span>Middlegame</span>
      </div>
      <div class="phase-legend-item">
        <span class="phase-legend-color endgame"></span>
        <span>Endgame</span>
      </div>
    </div>
  </div>
  <div class="phase-breakdown" id="phaseBreakdown">
    <div class="loading-placeholder">Loading...</div>
  </div>
</div>

<div class="chart-container">
  <div class="chart-title">Blunders by Color</div>
  <p class="chart-description">Compare your blunder rate when playing as white versus black.</p>
  <div class="phase-bar-container" id="colorBarContainer" style="display: none;">
    <div class="color-bar" id="colorBar"></div>
    <div class="color-legend">
      <div class="color-legend-item">
        <span class="color-legend-swatch white"></span>
        <span>White</span>
      </div>
      <div class="color-legend-item">
        <span class="color-legend-swatch black"></span>
        <span>Black</span>
      </div>
    </div>
  </div>
  <div class="color-breakdown" id="colorBreakdown">
    <div class="loading-placeholder">Loading...</div>
  </div>
</div>

<div class="chart-container">
  <div class="chart-title">Blunders by Game Type</div>
  <p class="chart-description">Compare your blunder rate across different time controls.</p>
  <div class="game-type-bar-container" id="gameTypeBarContainer" style="display: none;">
    <div class="game-type-bar" id="gameTypeBar"></div>
    <div class="game-type-legend" id="gameTypeLegend"></div>
  </div>
  <div class="game-type-breakdown" id="gameTypeBreakdown">
    <div class="loading-placeholder">Loading...</div>
  </div>
</div>

<div class="chart-container">
  <div class="chart-title">Blunders by Opening</div>
  <p class="chart-description">See which openings give you the most trouble.</p>
  <div id="ecoBreakdown">
    <div class="loading-placeholder">Loading...</div>
  </div>
</div>

<div class="chart-container">
  <div class="chart-title">Blunders by Tactical Pattern</div>
  <p class="chart-description">Understand what types of tactical mistakes you make most often.</p>
  <div class="tactical-bar-container" id="tacticalBarContainer" style="display: none;">
    <div class="tactical-bar" id="tacticalBar"></div>
    <div class="tactical-legend" id="tacticalLegend"></div>
  </div>
  <div class="tactical-breakdown" id="tacticalBreakdown">
    <div class="loading-placeholder">Loading...</div>
  </div>
</div>

<div class="chart-container">
  <div class="chart-title">Game Breakdown by Source</div>
  <table id="gameBreakdownTable">
    <thead>
      <tr>
        <th>Source</th>
        <th>Username</th>
        <th>Total Games</th>
        <th>Analyzed</th>
        <th>Pending</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="chart-container">
  <div class="chart-title">Games & Quality by Date</div>
  <p class="chart-description">Track your game volume and quality over time. Lower CPL = better play.</p>
  <div id="dateChartContainer" class="chart-canvas-container">
    <canvas id="dateChart"></canvas>
  </div>
  <div id="dateChartEmpty" class="chart-empty-state">
    No game data available yet. Import and analyze some games to see your trends.
  </div>
</div>

<div class="chart-container">
  <div class="chart-title">Performance by Hour of Day</div>
  <p class="chart-description">Discover when you play your best chess.</p>
  <div id="hourChartContainer" class="chart-canvas-container">
    <canvas id="hourChart"></canvas>
  </div>
  <div id="hourChartEmpty" class="chart-empty-state">
    No game data available yet. Import and analyze some games to see your hourly patterns.
  </div>
</div>

<div class="mt-4">
  <button class="btn" onclick="location.href='/management'">Manage Imports & Sync</button>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/heatmap.js"></script>
<script>
  let currentDateFrom = null;
  let currentDateTo = null;
  let configuredUsernames = {};
  let dateChart = null;
  let hourChart = null;

  async function loadConfiguredUsernames() {
    try {
      const resp = await fetch('/api/settings/usernames');
      if (resp.ok) {
        configuredUsernames = await resp.json();
      }
    } catch (err) {
      console.error('Failed to load configured usernames:', err);
    }
  }

  function getFirstUsername() {
    return configuredUsernames.lichess_username || configuredUsernames.chesscom_username || null;
  }

  function getPresetDates(preset) {
    const now = new Date();
    const to = now.toISOString().split('T')[0];
    let from = null;

    switch (preset) {
      case '7d':
        from = new Date(now - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        break;
      case '30d':
        from = new Date(now - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        break;
      case '90d':
        from = new Date(now - 90 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        break;
      case '1y':
        from = new Date(now - 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
        break;
      case 'all':
        return { from: null, to: null };
    }
    return { from, to };
  }

  function setPreset(preset) {
    const dates = getPresetDates(preset);
    document.getElementById('dateFrom').value = dates.from || '';
    document.getElementById('dateTo').value = dates.to || '';
    currentDateFrom = dates.from;
    currentDateTo = dates.to;

    // Update active button
    document.querySelectorAll('.filter-presets button').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.preset === preset);
    });

    loadStats();
  }

  function applyDateFilter() {
    currentDateFrom = document.getElementById('dateFrom').value || null;
    currentDateTo = document.getElementById('dateTo').value || null;

    // Clear preset buttons active state
    document.querySelectorAll('.filter-presets button').forEach(btn => btn.classList.remove('active'));

    loadStats();
  }

  function clearDateFilter() {
    document.getElementById('dateFrom').value = '';
    document.getElementById('dateTo').value = '';
    currentDateFrom = null;
    currentDateTo = null;

    // Set "All time" as active
    document.querySelectorAll('.filter-presets button').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.preset === 'all');
    });

    loadStats();
  }

  function buildUrl(baseUrl) {
    const params = new URLSearchParams();
    if (currentDateFrom) params.set('start_date', currentDateFrom);
    if (currentDateTo) params.set('end_date', currentDateTo);
    const queryString = params.toString();
    return queryString ? `${baseUrl}?${queryString}` : baseUrl;
  }

  async function loadStats() {
    try {
      // Load overview stats (no date filter for overview)
      const overviewResp = await fetch('/api/stats');
      const overview = await overviewResp.json();

      document.getElementById('totalGames').textContent = overview.total_games || 0;
      document.getElementById('analyzedGames').textContent = overview.analyzed_games || 0;
      document.getElementById('totalBlunders').textContent = overview.total_blunders || 0;

      // Calculate progress percentage
      const totalGames = overview.total_games || 0;
      const analyzedGames = overview.analyzed_games || 0;
      const progressPercent = totalGames > 0 ? Math.round((analyzedGames / totalGames) * 100) : 0;

      document.getElementById('progressPercent').textContent = progressPercent + '%';
      document.getElementById('progressFill').style.width = progressPercent + '%';

      // Check for running analysis job
      const analysisStatusResp = await fetch('/api/analysis/status');
      const analysisStatus = await analysisStatusResp.json();

      const statusEl = document.getElementById('analysisJobStatus');
      if (analysisStatus.status === 'running') {
        const percent = analysisStatus.progress_total > 0
          ? Math.round((analysisStatus.progress_current / analysisStatus.progress_total) * 100)
          : 0;
        statusEl.textContent = `Analysis running: ${analysisStatus.progress_current || 0}/${analysisStatus.progress_total || 0} (${percent}%)`;
        statusEl.style.color = 'var(--primary)';
      } else if (analysisStatus.status === 'completed') {
        statusEl.textContent = 'Last analysis: completed';
        statusEl.style.color = 'var(--success)';
      } else if (analysisStatus.status === 'failed') {
        statusEl.innerHTML = 'Last analysis: failed <button class="btn btn-sm" onclick="retryAnalysis()" style="margin-left: 8px; padding: 4px 10px; font-size: 0.75rem;">Retry</button>';
        statusEl.style.color = 'var(--error)';
      } else {
        statusEl.textContent = '';
      }

      // Load and render games by date chart
      await loadDateChart();

      // Load and render games by hour chart
      await loadHourChart();

      // Load blunders by phase (with date filter)
      const phaseResp = await fetch(buildUrl('/api/stats/blunders/by-phase'));
      const phaseData = await phaseResp.json();

      const phaseBreakdown = document.getElementById('phaseBreakdown');
      const phaseBarContainer = document.getElementById('phaseBarContainer');
      const phaseBar = document.getElementById('phaseBar');

      if (phaseData.total_blunders > 0 && phaseData.by_phase.length > 0) {
        phaseBarContainer.style.display = 'block';

        // Build the stacked bar
        phaseBar.innerHTML = phaseData.by_phase
          .filter(p => p.percentage > 0)
          .map(p => `<div class="phase-bar-segment ${p.phase}" style="width: ${p.percentage}%">${p.percentage > 10 ? p.percentage + '%' : ''}</div>`)
          .join('');

        // Build the phase cards
        phaseBreakdown.innerHTML = phaseData.by_phase.map(p => `
          <div class="phase-card ${p.phase}">
            <div class="phase-name">${p.phase}</div>
            <div class="phase-count">${p.count}</div>
            <div class="phase-percent">${p.percentage}% of blunders</div>
            <div class="phase-cpl">Avg. loss: ${(p.avg_cp_loss / 100).toFixed(1)} pawns</div>
          </div>
        `).join('');
      } else {
        phaseBarContainer.style.display = 'none';
        phaseBreakdown.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No blunder data available yet. Analyze some games to see your phase breakdown.</div>';
      }

      // Load blunders by color (with date filter and username)
      const username = getFirstUsername();
      let colorUrl = buildUrl('/api/stats/blunders/by-color');
      if (username) {
        colorUrl += (colorUrl.includes('?') ? '&' : '?') + 'username=' + encodeURIComponent(username);
      }
      const colorResp = await fetch(colorUrl);
      const colorData = await colorResp.json();

      const colorBreakdown = document.getElementById('colorBreakdown');
      const colorBarContainer = document.getElementById('colorBarContainer');
      const colorBar = document.getElementById('colorBar');

      if (colorData.total_blunders > 0 && colorData.by_color.length > 0) {
        colorBarContainer.style.display = 'block';

        // Build the comparison bar
        colorBar.innerHTML = colorData.by_color
          .filter(c => c.percentage > 0)
          .map(c => `<div class="color-bar-segment ${c.color}" style="width: ${c.percentage}%">${c.percentage > 15 ? c.percentage + '%' : ''}</div>`)
          .join('');

        // Build the color cards
        colorBreakdown.innerHTML = colorData.by_color.map(c => `
          <div class="color-card ${c.color}">
            <div class="color-name">As ${c.color}</div>
            <div class="color-count">${c.count}</div>
            <div class="color-percent">${c.percentage}% of blunders</div>
            <div class="color-cpl">Avg. loss: ${(c.avg_cp_loss / 100).toFixed(1)} pawns</div>
          </div>
        `).join('');
      } else {
        colorBarContainer.style.display = 'none';
        colorBreakdown.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No blunder data available yet. Analyze some games to see your color breakdown.</div>';
      }

      // Load blunders by game type (with date filter)
      const gameTypeResp = await fetch(buildUrl('/api/stats/blunders/by-game-type'));
      const gameTypeData = await gameTypeResp.json();

      const gameTypeBreakdown = document.getElementById('gameTypeBreakdown');
      const gameTypeBarContainer = document.getElementById('gameTypeBarContainer');
      const gameTypeBar = document.getElementById('gameTypeBar');
      const gameTypeLegend = document.getElementById('gameTypeLegend');

      // Map for display labels
      const gameTypeLabels = {
        'ultrabullet': 'UltraBullet',
        'bullet': 'Bullet',
        'blitz': 'Blitz',
        'rapid': 'Rapid',
        'classical': 'Classical',
        'correspondence': 'Correspondence',
        'unknown': 'Unknown'
      };

      if (gameTypeData.total_blunders > 0 && gameTypeData.by_game_type.length > 0) {
        gameTypeBarContainer.style.display = 'block';

        // Build the stacked bar
        gameTypeBar.innerHTML = gameTypeData.by_game_type
          .filter(g => g.percentage > 0)
          .map(g => `<div class="game-type-bar-segment ${g.game_type}" style="flex: ${g.percentage}">${g.percentage > 8 ? g.percentage + '%' : ''}</div>`)
          .join('');

        // Build the legend
        const usedTypes = gameTypeData.by_game_type.filter(g => g.count > 0).map(g => g.game_type);
        gameTypeLegend.innerHTML = usedTypes.map(type => `
          <div class="game-type-legend-item">
            <span class="game-type-legend-color ${type}"></span>
            <span>${gameTypeLabels[type] || type}</span>
          </div>
        `).join('');

        // Build the game type cards
        gameTypeBreakdown.innerHTML = gameTypeData.by_game_type
          .filter(g => g.count > 0)
          .map(g => `
            <div class="game-type-card ${g.game_type}">
              <div class="game-type-name">${gameTypeLabels[g.game_type] || g.game_type}</div>
              <div class="game-type-count">${g.count}</div>
              <div class="game-type-percent">${g.percentage}%</div>
            </div>
          `).join('');
      } else {
        gameTypeBarContainer.style.display = 'none';
        gameTypeBreakdown.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No game type data available yet. Analyze some games to see your blunders by time control.</div>';
      }

      // Load blunders by ECO opening (with date filter)
      const ecoResp = await fetch(buildUrl('/api/stats/blunders/by-eco'));
      const ecoData = await ecoResp.json();

      const ecoBreakdown = document.getElementById('ecoBreakdown');

      if (ecoData.total_blunders > 0 && ecoData.by_opening.length > 0) {
        ecoBreakdown.innerHTML = `
          <table class="eco-table">
            <thead>
              <tr>
                <th>Opening</th>
                <th>Blunders</th>
                <th>Avg. Loss</th>
                <th>Games</th>
              </tr>
            </thead>
            <tbody>
              ${ecoData.by_opening.map(item => `
                <tr>
                  <td><span class="eco-code">${item.eco_code}</span> ${item.eco_name}</td>
                  <td>${item.count} <span style="color: var(--text-muted); font-size: 0.75rem;">(${item.percentage}%)</span></td>
                  <td>${(item.avg_cp_loss / 100).toFixed(2)} pawns</td>
                  <td>${item.game_count}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } else {
        ecoBreakdown.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No opening data available yet. Analyze some games to see your opening breakdown.</div>';
      }

      // Load blunders by tactical pattern (with date filter)
      const tacticalResp = await fetch(buildUrl('/api/stats/blunders/by-tactical-pattern'));
      const tacticalData = await tacticalResp.json();

      const tacticalBreakdown = document.getElementById('tacticalBreakdown');
      const tacticalBarContainer = document.getElementById('tacticalBarContainer');
      const tacticalBar = document.getElementById('tacticalBar');
      const tacticalLegend = document.getElementById('tacticalLegend');

      // Map pattern names to CSS class names
      const patternToClass = {
        'Fork': 'fork',
        'Pin': 'pin',
        'Skewer': 'skewer',
        'Discovered Attack': 'discovered',
        'Discovered Check': 'discovered',
        'Double Check': 'discovered',
        'Hanging Piece': 'hanging',
        'Back Rank Threat': 'back_rank',
        'Trapped Piece': 'other',
        'None': 'other'
      };

      const patternLabels = {
        'Fork': 'Fork',
        'Pin': 'Pin',
        'Skewer': 'Skewer',
        'Discovered Attack': 'Discovery',
        'Discovered Check': 'Disc. Check',
        'Double Check': 'Double Check',
        'Hanging Piece': 'Hanging',
        'Back Rank Threat': 'Back Rank',
        'Trapped Piece': 'Trapped',
        'None': 'Other'
      };

      if (tacticalData.total_blunders > 0 && tacticalData.by_pattern.length > 0) {
        tacticalBarContainer.style.display = 'block';

        // Build the stacked bar
        tacticalBar.innerHTML = tacticalData.by_pattern
          .filter(p => p.percentage > 0)
          .map(p => {
            const cls = patternToClass[p.pattern] || 'other';
            return `<div class="tactical-bar-segment ${cls}" style="flex: ${p.percentage}">${p.percentage > 8 ? p.percentage + '%' : ''}</div>`;
          })
          .join('');

        // Build the legend
        const uniqueClasses = [...new Set(tacticalData.by_pattern.map(p => patternToClass[p.pattern] || 'other'))];
        tacticalLegend.innerHTML = uniqueClasses.map(cls => {
          const label = Object.entries(patternToClass).find(([k, v]) => v === cls)?.[0] || cls;
          return `
            <div class="tactical-legend-item">
              <span class="tactical-legend-color ${cls}"></span>
              <span>${patternLabels[label] || label}</span>
            </div>
          `;
        }).join('');

        // Build the tactical cards
        tacticalBreakdown.innerHTML = tacticalData.by_pattern
          .filter(p => p.count > 0)
          .map(p => {
            const cls = patternToClass[p.pattern] || 'other';
            const label = patternLabels[p.pattern] || p.pattern;
            return `
              <div class="tactical-card ${cls}">
                <div class="tactical-name">${label}</div>
                <div class="tactical-count">${p.count}</div>
                <div class="tactical-percent">${p.percentage}%</div>
              </div>
            `;
          }).join('');
      } else {
        tacticalBarContainer.style.display = 'none';
        tacticalBreakdown.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-muted);">No tactical pattern data available yet. Run a backfill to analyze existing blunders for tactical patterns.</div>';
      }

      // Load game breakdown
      const breakdownResp = await fetch('/api/stats/games');
      const breakdown = await breakdownResp.json();

      const tbody = document.querySelector('#gameBreakdownTable tbody');
      tbody.innerHTML = '';
      (breakdown.items || []).forEach(row => {
        tbody.innerHTML += `
          <tr>
            <td>${row.source}</td>
            <td>${row.username}</td>
            <td>${row.total_games}</td>
            <td>${row.analyzed_games}</td>
            <td>${row.pending_games}</td>
          </tr>
        `;
      });

    } catch (err) {
      console.error('Failed to load stats:', err);
    }
  }

  async function loadDateChart() {
    try {
      const resp = await fetch(buildUrl('/api/stats/games/by-date'));
      const data = await resp.json();

      const container = document.getElementById('dateChartContainer');
      const emptyMsg = document.getElementById('dateChartEmpty');

      if (!data.items || data.items.length === 0) {
        container.style.display = 'none';
        emptyMsg.style.display = 'block';
        return;
      }

      container.style.display = 'block';
      emptyMsg.style.display = 'none';

      const labels = data.items.map(d => d.date);
      const gameCounts = data.items.map(d => d.game_count);
      const avgCpls = data.items.map(d => d.avg_cpl);

      if (dateChart) {
        dateChart.destroy();
      }

      const ctx = document.getElementById('dateChart').getContext('2d');
      dateChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Games Played',
              data: gameCounts,
              backgroundColor: 'rgba(14, 165, 233, 0.7)',
              borderColor: 'rgba(14, 165, 233, 1)',
              borderWidth: 1,
              yAxisID: 'y',
              order: 2
            },
            {
              label: 'Avg CPL',
              data: avgCpls,
              type: 'line',
              borderColor: 'rgba(239, 68, 68, 1)',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.3,
              pointRadius: 3,
              yAxisID: 'y1',
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              position: 'top'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  if (context.dataset.label === 'Avg CPL') {
                    return `Avg CPL: ${context.raw.toFixed(1)} (${(context.raw / 100).toFixed(2)} pawns)`;
                  }
                  return `${context.dataset.label}: ${context.raw}`;
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                maxRotation: 45,
                minRotation: 45,
                maxTicksLimit: 15
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Games'
              },
              beginAtZero: true
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Avg CPL'
              },
              beginAtZero: true,
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });
    } catch (err) {
      console.error('Failed to load date chart:', err);
    }
  }

  async function loadHourChart() {
    try {
      const resp = await fetch(buildUrl('/api/stats/games/by-hour'));
      const data = await resp.json();

      const container = document.getElementById('hourChartContainer');
      const emptyMsg = document.getElementById('hourChartEmpty');

      if (!data.items || data.items.length === 0) {
        container.style.display = 'none';
        emptyMsg.style.display = 'block';
        return;
      }

      container.style.display = 'block';
      emptyMsg.style.display = 'none';

      // Fill in missing hours with zeros
      const hourMap = new Map(data.items.map(d => [d.hour, d]));
      const fullData = [];
      for (let h = 0; h < 24; h++) {
        if (hourMap.has(h)) {
          fullData.push(hourMap.get(h));
        } else {
          fullData.push({ hour: h, game_count: 0, avg_cpl: 0, blunders: 0 });
        }
      }

      const labels = fullData.map(d => `${d.hour.toString().padStart(2, '0')}:00`);
      const gameCounts = fullData.map(d => d.game_count);
      const avgCpls = fullData.map(d => d.avg_cpl);

      if (hourChart) {
        hourChart.destroy();
      }

      const ctx = document.getElementById('hourChart').getContext('2d');
      hourChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Games Played',
              data: gameCounts,
              backgroundColor: 'rgba(139, 92, 246, 0.7)',
              borderColor: 'rgba(139, 92, 246, 1)',
              borderWidth: 1,
              yAxisID: 'y',
              order: 2
            },
            {
              label: 'Avg CPL',
              data: avgCpls,
              type: 'line',
              borderColor: 'rgba(239, 68, 68, 1)',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              borderWidth: 2,
              fill: false,
              tension: 0.3,
              pointRadius: 3,
              yAxisID: 'y1',
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              position: 'top'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  if (context.dataset.label === 'Avg CPL') {
                    return `Avg CPL: ${context.raw.toFixed(1)} (${(context.raw / 100).toFixed(2)} pawns)`;
                  }
                  return `${context.dataset.label}: ${context.raw}`;
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Hour of Day (UTC)'
              }
            },
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: {
                display: true,
                text: 'Games'
              },
              beginAtZero: true
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: {
                display: true,
                text: 'Avg CPL'
              },
              beginAtZero: true,
              grid: {
                drawOnChartArea: false
              }
            }
          }
        }
      });
    } catch (err) {
      console.error('Failed to load hour chart:', err);
    }
  }

  async function retryAnalysis() {
    try {
      const resp = await fetch('/api/analysis/start', { method: 'POST' });
      if (resp.ok) {
        loadStats();
      } else {
        const data = await resp.json();
        alert(data.detail || 'Failed to start analysis');
      }
    } catch (err) {
      console.error('Failed to retry analysis:', err);
      alert('Failed to start analysis');
    }
  }

  // Load stats on page load (after loading configured usernames)
  loadConfiguredUsernames().then(() => loadStats());

  // Load activity heatmap
  loadHeatmap('activityHeatmap');

  // Initialize WebSocket for real-time updates
  wsClient.connect();
  wsClient.subscribe(['stats.updated', 'job.completed', 'job.progress_updated', 'job.status_changed']);

  // Handle stats updates
  wsClient.on('stats.updated', () => {
    // Reload all dashboard data
    loadStats();
  });

  wsClient.on('job.completed', () => {
    // Reload dashboard when any job completes
    loadStats();
  });

  wsClient.on('job.progress_updated', () => {
    // Update analysis status in real-time
    loadStats();
  });

  wsClient.on('job.status_changed', () => {
    // Update when job status changes
    loadStats();
  });
</script>
{% endblock %}
