{% extends "base.html" %}
{% from "_nav.html" import render_nav %}

{% block title %}{{ t('nav.dashboard') }} - Blunder Tutor{% endblock %}

{% block extra_head %}
<script src="/static/vendor/chart-4.4.1.umd.min.js"></script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/dashboard.css">
{% endblock %}

{% block content %}
<h1>{{ t('dashboard.title') }}</h1>
{{ render_nav('dashboard') }}

<div class="dashboard-filters">
  <div class="filter-group">
    <label for="dateFrom">{{ t('dashboard.filter.from') }}</label>
    <input type="date" id="dateFrom" name="date_from">
  </div>
  <div class="filter-group">
    <label for="dateTo">{{ t('dashboard.filter.to') }}</label>
    <input type="date" id="dateTo" name="date_to">
  </div>
  <div class="filter-group">
    <button class="btn" id="applyDateBtn">{{ t('common.apply') }}</button>
    <button class="btn btn-secondary" id="clearDateBtn">{{ t('common.clear') }}</button>
  </div>
  <div class="filter-presets">
    <button data-preset="7d">{{ t('dashboard.filter.last_7d') }}</button>
    <button data-preset="30d">{{ t('dashboard.filter.last_30d') }}</button>
    <button data-preset="90d">{{ t('dashboard.filter.last_90d') }}</button>
    <button data-preset="1y">{{ t('dashboard.filter.last_1y') }}</button>
    <button data-preset="all" class="active">{{ t('dashboard.filter.all_time') }}</button>
  </div>
</div>

<div class="dashboard-filters" style="margin-top: var(--space-2);">
  <div class="filter-group">
    <label>{{ t('dashboard.filter.time_control') }}</label>
    <div class="game-type-filters">
      <label class="checkbox-label">
        <input type="checkbox" class="game-type-filter" value="bullet" checked> {{ t('trainer.game_type.bullet') }}
      </label>
      <label class="checkbox-label">
        <input type="checkbox" class="game-type-filter" value="blitz" checked> {{ t('trainer.game_type.blitz') }}
      </label>
      <label class="checkbox-label">
        <input type="checkbox" class="game-type-filter" value="rapid" checked> {{ t('trainer.game_type.rapid') }}
      </label>
      <label class="checkbox-label">
        <input type="checkbox" class="game-type-filter" value="classical" checked> {{ t('trainer.game_type.classical') }}
      </label>
    </div>
  </div>
</div>

<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-label">{{ t('dashboard.stat.total_games') }}</div>
    <div class="stat-value" id="totalGames">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">{{ t('dashboard.stat.analyzed_games') }}</div>
    <div class="stat-value" id="analyzedGames">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">{{ t('dashboard.stat.total_blunders') }}</div>
    <div class="stat-value" id="totalBlunders">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">{{ t('dashboard.stat.analysis_progress') }}</div>
    <div class="stat-value" id="progressPercent">-</div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
    <div id="analysisJobStatus" class="text-sm text-muted mt-2"></div>
  </div>
</div>

{% if has_feature('dashboard.heatmap') %}
<div class="chart-container">
  <div class="chart-title">{{ t('dashboard.chart.puzzle_activity') }}</div>
  <p class="chart-description">{{ t('dashboard.chart.puzzle_activity_desc') }}</p>
  <div id="activityHeatmap">
    <div class="loading-placeholder">{{ t('dashboard.chart.loading_activity') }}</div>
  </div>
</div>
{% endif %}

{% if has_feature('dashboard.phase_breakdown') %}
<div class="chart-container">
  <div class="chart-title">{{ t('dashboard.chart.blunders_by_phase') }}</div>
  <p class="chart-description">{{ t('dashboard.chart.blunders_by_phase_desc') }}</p>
  <div class="phase-bar-container" id="phaseBarContainer" style="display: none;">
    <div class="phase-bar" id="phaseBar"></div>
    <div class="phase-legend">
      <div class="phase-legend-item">
        <span class="phase-legend-color opening"></span>
        <span>{{ t('chess.phase.opening') }}</span>
      </div>
      <div class="phase-legend-item">
        <span class="phase-legend-color middlegame"></span>
        <span>{{ t('chess.phase.middlegame') }}</span>
      </div>
      <div class="phase-legend-item">
        <span class="phase-legend-color endgame"></span>
        <span>{{ t('chess.phase.endgame') }}</span>
      </div>
    </div>
  </div>
  <div class="phase-breakdown" id="phaseBreakdown">
    <div class="loading-placeholder">{{ t('common.loading') }}</div>
  </div>
</div>
{% endif %}

<div class="chart-container">
  <div class="chart-title">{{ t('dashboard.chart.blunders_by_color') }}</div>
  <p class="chart-description">{{ t('dashboard.chart.blunders_by_color_desc') }}</p>
  <div class="phase-bar-container" id="colorBarContainer" style="display: none;">
    <div class="color-bar" id="colorBar"></div>
    <div class="color-legend">
      <div class="color-legend-item">
        <span class="color-legend-swatch white"></span>
        <span>{{ t('chess.color.white') }}</span>
      </div>
      <div class="color-legend-item">
        <span class="color-legend-swatch black"></span>
        <span>{{ t('chess.color.black') }}</span>
      </div>
    </div>
  </div>
  <div class="color-breakdown" id="colorBreakdown">
    <div class="loading-placeholder">{{ t('common.loading') }}</div>
  </div>
</div>

<div class="chart-container">
  <div class="chart-title">{{ t('dashboard.chart.blunders_by_game_type') }}</div>
  <p class="chart-description">{{ t('dashboard.chart.blunders_by_game_type_desc') }}</p>
  <div class="game-type-bar-container" id="gameTypeBarContainer" style="display: none;">
    <div class="game-type-bar" id="gameTypeBar"></div>
    <div class="game-type-legend" id="gameTypeLegend"></div>
  </div>
  <div class="game-type-breakdown" id="gameTypeBreakdown">
    <div class="loading-placeholder">{{ t('common.loading') }}</div>
  </div>
</div>

{% if has_feature('dashboard.opening_breakdown') %}
<div class="chart-container">
  <div class="chart-title">{{ t('dashboard.chart.blunders_by_opening') }}</div>
  <p class="chart-description">{{ t('dashboard.chart.blunders_by_opening_desc') }}</p>
  <div id="ecoBreakdown">
    <div class="loading-placeholder">{{ t('common.loading') }}</div>
  </div>
</div>
{% endif %}

{% if has_feature('dashboard.difficulty_breakdown') %}
<div class="chart-container">
  <div class="chart-title">
    {{ t('dashboard.chart.blunders_by_difficulty') }}
    <button class="info-help-btn" id="difficultyHelpBtn" aria-label="{{ t('dashboard.difficulty.help_label') }}">?</button>
  </div>
  <p class="chart-description">{{ t('dashboard.chart.blunders_by_difficulty_desc') }}</p>
  <div class="difficulty-bar-container" id="difficultyBarContainer" style="display: none;">
    <div class="difficulty-bar" id="difficultyBar"></div>
    <div class="difficulty-legend" id="difficultyLegend"></div>
  </div>
  <div class="difficulty-breakdown" id="difficultyBreakdown">
    <div class="loading-placeholder">{{ t('common.loading') }}</div>
  </div>
</div>
{% endif %}

{% if has_feature('dashboard.tactical_breakdown') %}
<div class="chart-container">
  <div class="chart-title">{{ t('dashboard.chart.blunders_by_tactical') }}</div>
  <p class="chart-description">{{ t('dashboard.chart.blunders_by_tactical_desc') }}</p>
  <div class="tactical-bar-container" id="tacticalBarContainer" style="display: none;">
    <div class="tactical-bar" id="tacticalBar"></div>
    <div class="tactical-legend" id="tacticalLegend"></div>
  </div>
  <div class="tactical-breakdown" id="tacticalBreakdown">
    <div class="loading-placeholder">{{ t('common.loading') }}</div>
  </div>
</div>
{% endif %}

<div class="chart-container">
  <div class="chart-title">{{ t('dashboard.chart.game_breakdown') }}</div>
  <table id="gameBreakdownTable">
    <thead>
      <tr>
        <th>{{ t('dashboard.chart.source') }}</th>
        <th>{{ t('dashboard.chart.username') }}</th>
        <th>{{ t('dashboard.chart.total_games') }}</th>
        <th>{{ t('dashboard.chart.analyzed') }}</th>
        <th>{{ t('dashboard.chart.pending') }}</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

{% if has_feature('dashboard.accuracy') %}
<div class="chart-container">
  <div class="chart-title">{{ t('dashboard.chart.accuracy_by_date') }}</div>
  <p class="chart-description">{{ t('dashboard.chart.accuracy_by_date_desc') }}</p>
  <div id="dateChartContainer" class="chart-canvas-container">
    <canvas id="dateChart"></canvas>
  </div>
  <div id="dateChartEmpty" class="chart-empty-state">
    {{ t('dashboard.chart.no_accuracy_data') }}
  </div>
</div>

<div class="chart-container">
  <div class="chart-title">{{ t('dashboard.chart.accuracy_by_hour') }}</div>
  <p class="chart-description">{{ t('dashboard.chart.accuracy_by_hour_desc') }}</p>
  <div id="hourChartContainer" class="chart-canvas-container">
    <canvas id="hourChart"></canvas>
  </div>
  <div id="hourChartEmpty" class="chart-empty-state">
    {{ t('dashboard.chart.no_hourly_data') }}
  </div>
</div>
{% endif %}

<div class="mt-4">
  <a class="btn" href="/management">{{ t('dashboard.link.manage_imports') }}</a>
</div>

<!-- Difficulty help modal -->
<div class="info-modal-overlay" id="difficultyHelpOverlay">
  <div class="info-modal">
    <div class="info-modal-header">
      <h3>{{ t('dashboard.difficulty.help_title') }}</h3>
      <button class="info-modal-close" id="difficultyHelpClose">&times;</button>
    </div>
    <div class="info-modal-body">
      <p>{{ t('dashboard.difficulty.help_intro') }}</p>
      <dl class="info-modal-definitions">
        <dt class="diff-easy">{{ t('dashboard.difficulty.easy') }} (0–30)</dt>
        <dd>{{ t('dashboard.difficulty.help_easy') }}</dd>
        <dt class="diff-medium">{{ t('dashboard.difficulty.medium') }} (31–60)</dt>
        <dd>{{ t('dashboard.difficulty.help_medium') }}</dd>
        <dt class="diff-hard">{{ t('dashboard.difficulty.hard') }} (61–100)</dt>
        <dd>{{ t('dashboard.difficulty.help_hard') }}</dd>
      </dl>
      <p class="info-modal-note">{{ t('dashboard.difficulty.help_factors') }}</p>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script type="module" src="/static/js/dashboard.js"></script>
{% endblock %}
