{% extends "base.html" %}
{% from "_nav.html" import render_nav %}

{% block title %}Dashboard - Blunder Tutor{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/dashboard.css">
{% endblock %}

{% block content %}
<h1>Blunder Tutor Dashboard</h1>
{{ render_nav('dashboard') }}

<div class="dashboard-filters">
  <div class="filter-group">
    <label for="dateFrom">From:</label>
    <input type="date" id="dateFrom" name="date_from">
  </div>
  <div class="filter-group">
    <label for="dateTo">To:</label>
    <input type="date" id="dateTo" name="date_to">
  </div>
  <div class="filter-group">
    <button class="btn" id="applyDateBtn">Apply</button>
    <button class="btn btn-secondary" id="clearDateBtn">Clear</button>
  </div>
  <div class="filter-presets">
    <button data-preset="7d">Last 7 days</button>
    <button data-preset="30d">Last 30 days</button>
    <button data-preset="90d">Last 90 days</button>
    <button data-preset="1y">Last year</button>
    <button data-preset="all" class="active">All time</button>
  </div>
</div>

<div class="dashboard-filters" style="margin-top: var(--space-2);">
  <div class="filter-group">
    <label>Time Control:</label>
    <div class="game-type-filters">
      <label class="checkbox-label">
        <input type="checkbox" class="game-type-filter" value="bullet" checked> Bullet
      </label>
      <label class="checkbox-label">
        <input type="checkbox" class="game-type-filter" value="blitz" checked> Blitz
      </label>
      <label class="checkbox-label">
        <input type="checkbox" class="game-type-filter" value="rapid" checked> Rapid
      </label>
      <label class="checkbox-label">
        <input type="checkbox" class="game-type-filter" value="classical" checked> Classical
      </label>
    </div>
  </div>
</div>

<div class="stats-grid">
  <div class="stat-card">
    <div class="stat-label">Total Games</div>
    <div class="stat-value" id="totalGames">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Analyzed Games</div>
    <div class="stat-value" id="analyzedGames">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Total Blunders</div>
    <div class="stat-value" id="totalBlunders">-</div>
  </div>
  <div class="stat-card">
    <div class="stat-label">Analysis Progress</div>
    <div class="stat-value" id="progressPercent">-</div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
    <div id="analysisJobStatus" class="text-sm text-muted mt-2"></div>
  </div>
</div>

<div class="chart-container">
  <div class="chart-title">Puzzle Activity</div>
  <p class="chart-description">Your puzzle solving activity over the past year.</p>
  <div id="activityHeatmap">
    <div class="loading-placeholder">Loading activity data...</div>
  </div>
</div>

<div class="chart-container">
  <div class="chart-title">Blunders by Game Phase</div>
  <p class="chart-description">Understand where in your games you tend to make mistakes.</p>
  <div class="phase-bar-container" id="phaseBarContainer" style="display: none;">
    <div class="phase-bar" id="phaseBar"></div>
    <div class="phase-legend">
      <div class="phase-legend-item">
        <span class="phase-legend-color opening"></span>
        <span>Opening</span>
      </div>
      <div class="phase-legend-item">
        <span class="phase-legend-color middlegame"></span>
        <span>Middlegame</span>
      </div>
      <div class="phase-legend-item">
        <span class="phase-legend-color endgame"></span>
        <span>Endgame</span>
      </div>
    </div>
  </div>
  <div class="phase-breakdown" id="phaseBreakdown">
    <div class="loading-placeholder">Loading...</div>
  </div>
</div>

<div class="chart-container">
  <div class="chart-title">Blunders by Color</div>
  <p class="chart-description">Compare your blunder rate when playing as white versus black.</p>
  <div class="phase-bar-container" id="colorBarContainer" style="display: none;">
    <div class="color-bar" id="colorBar"></div>
    <div class="color-legend">
      <div class="color-legend-item">
        <span class="color-legend-swatch white"></span>
        <span>White</span>
      </div>
      <div class="color-legend-item">
        <span class="color-legend-swatch black"></span>
        <span>Black</span>
      </div>
    </div>
  </div>
  <div class="color-breakdown" id="colorBreakdown">
    <div class="loading-placeholder">Loading...</div>
  </div>
</div>

<div class="chart-container">
  <div class="chart-title">Blunders by Game Type</div>
  <p class="chart-description">Compare your blunder rate across different time controls.</p>
  <div class="game-type-bar-container" id="gameTypeBarContainer" style="display: none;">
    <div class="game-type-bar" id="gameTypeBar"></div>
    <div class="game-type-legend" id="gameTypeLegend"></div>
  </div>
  <div class="game-type-breakdown" id="gameTypeBreakdown">
    <div class="loading-placeholder">Loading...</div>
  </div>
</div>

<div class="chart-container">
  <div class="chart-title">Blunders by Opening</div>
  <p class="chart-description">See which openings give you the most trouble.</p>
  <div id="ecoBreakdown">
    <div class="loading-placeholder">Loading...</div>
  </div>
</div>

<div class="chart-container">
  <div class="chart-title">Blunders by Tactical Pattern</div>
  <p class="chart-description">Understand what types of tactical mistakes you make most often.</p>
  <div class="tactical-bar-container" id="tacticalBarContainer" style="display: none;">
    <div class="tactical-bar" id="tacticalBar"></div>
    <div class="tactical-legend" id="tacticalLegend"></div>
  </div>
  <div class="tactical-breakdown" id="tacticalBreakdown">
    <div class="loading-placeholder">Loading...</div>
  </div>
</div>

<div class="chart-container">
  <div class="chart-title">Game Breakdown by Source</div>
  <table id="gameBreakdownTable">
    <thead>
      <tr>
        <th>Source</th>
        <th>Username</th>
        <th>Total Games</th>
        <th>Analyzed</th>
        <th>Pending</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="chart-container">
  <div class="chart-title">Game Accuracy by Date</div>
  <p class="chart-description">Track your game accuracy over time. Higher = better play (0â€“100 scale).</p>
  <div id="dateChartContainer" class="chart-canvas-container">
    <canvas id="dateChart"></canvas>
  </div>
  <div id="dateChartEmpty" class="chart-empty-state">
    No game data available yet. Import and analyze some games to see your accuracy trends.
  </div>
</div>

<div class="chart-container">
  <div class="chart-title">Game Accuracy by Hour of Day</div>
  <p class="chart-description">Discover when you play your most accurate chess.</p>
  <div id="hourChartContainer" class="chart-canvas-container">
    <canvas id="hourChart"></canvas>
  </div>
  <div id="hourChartEmpty" class="chart-empty-state">
    No game data available yet. Import and analyze some games to see your hourly accuracy patterns.
  </div>
</div>

<div class="mt-4">
  <a class="btn" href="/management">Manage Imports & Sync</a>
</div>
{% endblock %}

{% block extra_scripts %}
<script type="module" src="/static/js/dashboard.js"></script>
{% endblock %}
