{% extends "base.html" %}
{% from "_nav.html" import render_link_nav %}

{% block title %}{{ title }} - Blunder Tutor{% endblock %}

{% block extra_head %}
<!-- Preload chess piece images for fast initial render -->
<link rel="preload" href="/static/pieces/wikipedia/wK.png" as="image">
<link rel="preload" href="/static/pieces/wikipedia/wQ.png" as="image">
<link rel="preload" href="/static/pieces/wikipedia/wR.png" as="image">
<link rel="preload" href="/static/pieces/wikipedia/wB.png" as="image">
<link rel="preload" href="/static/pieces/wikipedia/wN.png" as="image">
<link rel="preload" href="/static/pieces/wikipedia/wP.png" as="image">
<link rel="preload" href="/static/pieces/wikipedia/bK.png" as="image">
<link rel="preload" href="/static/pieces/wikipedia/bQ.png" as="image">
<link rel="preload" href="/static/pieces/wikipedia/bR.png" as="image">
<link rel="preload" href="/static/pieces/wikipedia/bB.png" as="image">
<link rel="preload" href="/static/pieces/wikipedia/bN.png" as="image">
<link rel="preload" href="/static/pieces/wikipedia/bP.png" as="image">

<!-- Chessboard CSS -->
<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/trainer.css">
{% endblock %}

{% block body %}
<div class="container">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h1 style="margin: 0;">Blunder Trainer</h1>
    {{ render_link_nav() }}
  </div>

  <!-- Training Stats Section (HTMX-powered) -->
  <div class="card" style="margin-bottom: 24px; padding: 20px;" id="statsCard">
    <div
      id="statsContent"
      hx-get="/api/stats/training/html"
      hx-trigger="load, statsUpdate from:body"
      hx-swap="innerHTML transition:true">
      <!-- Stats will be loaded here via HTMX on page load and after each submission -->
      <div style="text-align: center; padding: 20px; color: var(--text-muted);">
        Loading stats...
      </div>
    </div>
  </div>

  <!-- Empty state: shown when no games/blunders are available -->
  <div class="card empty-state" id="emptyState" style="display: none;">
    <div class="empty-state-icon">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
      </svg>
    </div>
    <h2 class="empty-state-title" id="emptyStateTitle">No puzzles available</h2>
    <p class="empty-state-message" id="emptyStateMessage">
      Import your games to start training on your blunders.
    </p>
    <div class="empty-state-actions">
      <a href="/management" class="btn btn-primary" id="emptyStateAction">Import Games</a>
      <a href="/dashboard" class="btn btn-secondary">View Dashboard</a>
    </div>
  </div>

  <div class="layout" id="trainerLayout">
    <!-- Board column -->
    <div class="card board-container">
      <div class="eval-bar-container">
        <div class="eval-bar">
          <div class="eval-bar-fill" id="evalBarFill" style="width: 50%"></div>
        </div>
        <div class="eval-value" id="evalValue">0.0</div>
      </div>
      <div id="boardWrapper" style="position: relative;">
        <div id="board"></div>
        <div class="arrow-overlay" id="arrowOverlay"></div>
      </div>
      <div class="highlight-legend" id="highlightLegend" style="display: none;">
        <div class="legend-item" id="legendBlunder">
          <span class="legend-color blunder"></span>
          <span>Your blunder</span>
        </div>
        <div class="legend-item" id="legendBest">
          <span class="legend-color best"></span>
          <span>Best move</span>
        </div>
        <div class="legend-item" id="legendUser" style="display: none;">
          <span class="legend-color user"></span>
          <span>Your move</span>
        </div>
        <div class="legend-item" id="legendTactic" style="display: none;">
          <span class="legend-color tactic"></span>
          <span>Tactical squares</span>
        </div>
      </div>
      <div class="arrow-toggle">
        <input type="checkbox" id="showArrows" checked>
        <label for="showArrows">Show move arrows</label>
      </div>
      <div class="arrow-toggle">
        <input type="checkbox" id="showThreats" checked>
        <label for="showThreats">Show threats (hanging pieces, pins, checks)</label>
      </div>
      <div class="arrow-toggle">
        <input type="checkbox" id="showTactics">
        <label for="showTactics">Highlight tactical pattern (after reveal)</label>
      </div>
    </div>

    <!-- Controls column -->
    <div class="card">
      <!-- Phase indicator -->
      <div class="panel-section">
        <span class="phase guess" id="phaseIndicator">Find the best move</span>
        <span class="color-badge white" id="colorBadge" style="margin-left: 10px;">
          <span class="color-dot white"></span>
          Playing as White
        </span>
        <span class="phase-badge" id="phaseBadge" style="display: none; margin-left: 10px;"></span>
        <span class="tactical-badge" id="tacticalBadge" style="display: none; margin-left: 10px;">
          <span class="icon">‚öîÔ∏è</span>
          <span id="tacticalPatternName">Fork</span>
        </span>
      </div>

      <!-- Filters Panel (collapsible) -->
      <div class="panel-section filters-panel">
        <div class="section-title filters-header" id="filtersHeader">
          <span>Puzzle Filters</span>
          <button class="filters-toggle-btn" id="filtersToggleBtn" title="Toggle filters">
            <svg class="chevron-icon" id="filtersChevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
        </div>

        <div class="filters-content" id="filtersContent">
          <!-- Game Type filter -->
          <div class="filter-group">
            <div class="filter-label">Game Type</div>
            <div class="game-type-filter">
              <label class="filter-checkbox-label">
                <input type="checkbox" class="game-type-checkbox" value="bullet" checked>
                <span class="game-type-icon">üî´</span> Bullet
              </label>
              <label class="filter-checkbox-label">
                <input type="checkbox" class="game-type-checkbox" value="blitz" checked>
                <span class="game-type-icon">‚ö°</span> Blitz
              </label>
              <label class="filter-checkbox-label">
                <input type="checkbox" class="game-type-checkbox" value="rapid" checked>
                <span class="game-type-icon">üïê</span> Rapid
              </label>
              <label class="filter-checkbox-label">
                <input type="checkbox" class="game-type-checkbox" value="classical">
                <span class="game-type-icon">üèõÔ∏è</span> Classical
              </label>
            </div>
          </div>

          <!-- Color filter -->
          <div class="filter-group">
            <div class="filter-label">Play as Color</div>
            <div class="color-filter">
              <label class="filter-radio-label">
                <input type="radio" name="colorFilter" value="both" checked>
                <span class="color-option both">Both</span>
              </label>
              <label class="filter-radio-label">
                <input type="radio" name="colorFilter" value="white">
                <span class="color-option white">‚ôî White</span>
              </label>
              <label class="filter-radio-label">
                <input type="radio" name="colorFilter" value="black">
                <span class="color-option black">‚ôö Black</span>
              </label>
            </div>
          </div>

          <!-- Phase filter -->
          <div class="filter-group">
            <div class="filter-label">Game Phase</div>
            <div class="phase-filter">
              <label class="filter-checkbox-label">
                <input type="checkbox" class="phase-filter-checkbox" value="opening" checked>
                Opening
              </label>
              <label class="filter-checkbox-label">
                <input type="checkbox" class="phase-filter-checkbox" value="middlegame" checked>
                Middlegame
              </label>
              <label class="filter-checkbox-label">
                <input type="checkbox" class="phase-filter-checkbox" value="endgame" checked>
                Endgame
              </label>
            </div>
          </div>

          <!-- Tactical pattern filter -->
          <div class="filter-group">
            <div class="filter-label">Tactical Pattern</div>
            <div class="tactical-filter" id="tacticalFilter">
              <button class="tactical-filter-btn active" data-pattern="all">All</button>
              <button class="tactical-filter-btn" data-pattern="fork">Fork</button>
              <button class="tactical-filter-btn" data-pattern="pin">Pin</button>
              <button class="tactical-filter-btn" data-pattern="hanging_piece">Hanging</button>
              <button class="tactical-filter-btn" data-pattern="skewer">Skewer</button>
              <button class="tactical-filter-btn" data-pattern="discovered_attack">Discovery</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Your blunder section -->
      <div class="panel-section">
        <div class="section-title">Your Blunder</div>
        <div class="blunder-info">
          <div class="blunder-move">
            <span class="icon">??</span>
            <span id="blunderMove">...</span>
          </div>
          <div class="blunder-eval">
            Evaluation: <span id="evalBefore">...</span> &rarr; <span id="evalAfter">...</span>
            (<span class="loss" id="cpLoss">...</span> lost)
          </div>
        </div>
      </div>

      <!-- Feedback area -->
      <div class="feedback" id="feedback">
        <div class="feedback-title" id="feedbackTitle"></div>
        <div class="feedback-detail" id="feedbackDetail"></div>
      </div>

      <!-- Move indicator -->
      <div class="move-indicator">
        <span class="label">Your move:</span>
        <span class="move" id="currentMove">-</span>
      </div>

      <!-- Action buttons -->
      <div class="panel-section">
        <div class="btn-row">
          <button class="btn btn-primary" id="submitBtn">Submit<kbd>Enter</kbd></button>
          <button class="btn btn-secondary" id="resetBtn">Reset<kbd>R</kbd></button>
          <button class="btn btn-secondary" id="showBestBtn">Show Best</button>
          <button class="btn btn-success" id="nextBtn">Next<kbd>N</kbd></button>
          <button class="btn btn-secondary" id="lichessBtn" title="Analyze on Lichess">
            <svg width="16" height="16" viewBox="0 0 50 50" fill="currentColor" style="vertical-align: middle;">
              <path d="M36.7 8.3c-1.1-1.1-2.5-1.6-4-1.6-1.5 0-2.9.6-4 1.6L12.3 24.7c-2.2 2.2-2.2 5.8 0 8s5.8 2.2 8 0l16.4-16.4c1.1-1.1 1.6-2.5 1.6-4s-.5-2.9-1.6-4zm-4 5.7L16.3 30.4c-.8.8-2 .8-2.8 0s-.8-2 0-2.8L29.9 11.2c.4-.4.9-.6 1.4-.6s1 .2 1.4.6.6.9.6 1.4-.2 1-.6 1.4z"/>
            </svg>
            Lichess
          </button>
        </div>
      </div>

      <!-- Best move reveal (hidden initially) -->
      <div class="best-move-info" id="bestMoveInfo">
        <div class="section-title">Best Move</div>
        <div class="best-move" id="bestMoveDisplay">...</div>
        <div class="best-line">Line: <span id="bestLineDisplay">...</span></div>
        <!-- Tactical explanation -->
        <div class="tactical-info" id="tacticalInfo" style="display: none;">
          <div class="tactical-info-title">
            <span>üí°</span>
            <span id="tacticalInfoTitle">Tactical Pattern</span>
          </div>
          <div class="tactical-info-reason" id="tacticalInfoReason">...</div>
        </div>
        <div class="try-best-move">
          <button class="btn btn-success" id="tryBestBtn">Play Best Move on Board</button>
        </div>
      </div>

      <!-- Instructions -->
      <div class="panel-section">
        <div class="section-title">Instructions</div>
        <div class="instructions">
          <strong>Goal:</strong> Find a better move than your blunder.<br/>
          Drag pieces to make a move, then click Submit to check.<br/>
          Click "Show Best" to reveal the engine's recommendation.
        </div>
      </div>

      <!-- Move history for exploration -->
      <div class="panel-section" id="historySection" style="display: none;">
        <div class="section-title">Exploration</div>
        <div class="move-history" id="moveHistory"></div>
        <div style="margin-top: 10px;">
          <button class="btn btn-secondary" id="undoBtn" style="padding: 8px 14px; font-size: 0.85rem;">Undo</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block base_scripts %}
<!-- jQuery (required by chessboard.js) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<!-- Chess.js for move validation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<!-- Chessboard.js for board display -->
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
{% endblock %}

{% block extra_scripts %}
<!-- Trainer-specific JavaScript -->
<script src="/static/js/trainer.js?v=6"></script>

<!-- WebSocket integration for real-time stats updates -->
<script>
  // Initialize WebSocket for instant stats updates
  wsClient.connect();
  wsClient.subscribe(['stats.updated']);

  // Refresh stats widget when stats update
  wsClient.on('stats.updated', () => {
    htmx.trigger('#statsContent', 'statsUpdate');
  });
</script>
{% endblock %}
